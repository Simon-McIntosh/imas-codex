# ITER Organization - SDCC (Scientific Data Computing Center)
#
# Public facility configuration for graph and mappings.
# Infrastructure data is in iter_private.yaml (gitignored).

facility: iter
name: ITER Organization
machine: ITER
description: International Thermonuclear Experimental Reactor - SDCC
location: Cadarache, France

# SSH host alias - auto-detected as local when running on SDCC
# (hostname contains 'iter' so run() executes locally without SSH)
ssh_host: iter

# Login node FQDN patterns for is_local_host() detection.
# When the current machine's FQDN matches any pattern, the local_hosts
# aliases below are treated as local (no SSH needed).
# Both FQDN and short hostname are tested against these patterns.
login_nodes:
  - "98dci4-srv-*.iter.org"
  - "98dci4-gpu-*.iter.org"
  - "98dci4-srv-*"
  - "98dci4-gpu-*"

# SSH aliases treated as local when running on a matching login node.
local_hosts:
  - iter

# Compute sub-locations â€” SLURM partitions addressable as service locations.
# When pyproject.toml sets location = "titan", the code looks up this table
# to derive: facility=iter, scheduler=slurm, partition=titan.
compute_locations:
  titan:
    scheduler: slurm
    partition: titan
    service_job_name: imas-codex-services

# Data systems available at this facility
data_systems:
  - imas
  - mdsplus

# Data source configuration for signal discovery
# Used by: imas-codex discover signals iter
data_sources:
  # IMAS is ITER's native data format.
  imas:
    backends:
      - mdsplus
      - hdf5
    db_name: iter

# Data access patterns discovered during facility exploration.
data_access_patterns:
  primary_method: imas
  shot_identifier: shot
  signal_naming: >-
    IMAS IDS-based access: ids.equilibrium.time_slice[0].profiles_1d.psi.
    Python: entry = imas.DBEntry(uri, mode); entry.get('equilibrium').
    DBEntry methods: open, close, create, get, get_slice, get_node,
    partial_get, put, put_slice, list_all_occurrences, delete_data,
    build_uri_from_legacy_parameters.
    URI format: imas:mdsplus?path=/work/imas/shared/imasdb/<db>&pulse=N&run=M.
  tree_organization: >-
    IMAS Interface Data Structures (IDS) organized by physics domain:
    equilibrium, core_profiles, edge_profiles, magnetics, etc.
    Each IDS has a standard schema defined by the IMAS Data Dictionary.
    Shared databases at /work/imas/shared/imasdb/: iter, ITER,
    iter_disruptions, iter_machine_description, iter_md, iter_scenarios,
    jet, JET, JT-60U, AMNS, DTT, HCD, PDS, SST-1, TEST.
    Backends: MDSPLUS_BACKEND=12, HDF5_BACKEND=13, MEMORY_BACKEND=14,
    UDA_BACKEND=15, ASCII_BACKEND=11.
  key_tools:
    - imas.DBEntry
    - imasdef
    - imas
    - JINTRAC
    - iplotWidgets
  wiki_signal_patterns:
    - IDS field documentation
    - Data Dictionary references
    - IMAS access code examples
    - DBEntry URI examples
    - IDS occurrence listings
    - JINTRAC workflow documentation
  code_import_patterns:
    - import imas
    - from imas import
    - imas.DBEntry
    - imas.imasdef
    - DBEntry(
    - .get(
    - .put(
    - .get_slice(
    - .partial_get(
    - imasdef.MDSPLUS_BACKEND
    - imasdef.HDF5_BACKEND
  notes:
    - "IMAS AL version 5.3.1, DD version 3.42.0"
    - "DBEntry methods: open, close, create, get, get_slice, get_node, partial_get, put, put_slice, list_all_occurrences, delete_data"
    - "Backends: ASCII=11, MDSPLUS=12, HDF5=13, MEMORY=14, UDA=15 (via imas.imasdef)"
    - "Shared imasdb at /work/imas/shared/imasdb/ with 30+ databases: iter, jet, JT-60U, AMNS, DTT, etc."
    - "IMAS-AL-Core versions up to 5.4.1, IMAS-AL-Common 1.0.6"
    - "JINTRAC available (36.0.5, 37.0.0) for integrated modeling workflows"
    - "iplotWidgets available for IDS visualization"
    - "Module system: source /etc/profile.d/z00_lmod.sh + module load IMAS"

# Wiki/documentation sites (stored in private YAML, never graphed)
# Each site: {url, portal_page, site_type, auth_type, credential_service}
wiki_sites:
  - url: https://confluence.iter.org
    portal_page: IMP
    site_type: confluence
    access_method: direct  # Accessible from internet (no VPN/SSH needed)
    auth_type: session     # Username/password session login
    credential_service: iter
    ssh_available: false   # Confluence is a web service, no SSH route

# User info discovery configuration
# GECOS = General Comprehensive Operating System (5th field in /etc/passwd)
user_info:
  name_format: last_first  # ITER uses "Last First [EXT]" format
  gecos_suffix_pattern: "\\s+EXT$"  # Strip trailing " EXT" from names
  home_path_pattern: "^/home/ITER/([a-z0-9_-]+)(?:/|$)"  # /home/ITER/username
  lookup_tools:  # Ordered fallback list
    - getent   # POSIX standard, includes LDAP/NIS/SSSD
    - passwd   # /etc/passwd fallback
    - id       # existence check only