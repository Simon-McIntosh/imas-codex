# JT-60SA - Japan Torus 60 Super Advanced
#
# Public facility configuration for graph and mappings.
# Infrastructure data is in jt60sa_private.yaml (gitignored).

facility: jt60sa
name: JT-60SA
machine: JT60SA
description: Japan Torus 60 Super Advanced - Satellite tokamak facility
location: Naka, Japan

# SSH connection (user configures ~/.ssh/config with this alias)
ssh_host: jt60sa

# Data systems available at this facility
data_systems:
  - edas     # JT-60SA Experiment Data Access System (primary)
  - imas     # IMAS available via modules
  - mdsplus  # MDSplus available via modules
  - uda      # UDA available via modules

# Data source configuration for signal discovery
# Used by: imas-codex discover signals jt60sa
data_sources:
  # EDAS is JT-60SA's primary experiment data access system.
  # Wraps proprietary data formats with C/Fortran/Python APIs.
  edas:
    api_path: /analysis/src/eddb
    lib_path: /analysis/lib/libeddb.so
    header_path: /analysis/src/edas/include
    reference_shot: 1000  # TODO: confirm valid reference shot
    # No special Python or module setup needed — eddb_pwrapper uses ctypes
    # and the script handles sys.path insertion internally

  # IMAS data available via modules
  imas:
    backends:
      - mdsplus
    db_name: jt60sa

# Data access patterns discovered during facility exploration.
data_access_patterns:
  primary_method: edas
  shot_identifier: shot
  signal_naming: >-
    EDAS EDDB API: EDDB_locallib_API with methods opendb(dbtype), closedb(),
    get_time_nearest(shot, t, dname, cat), get_time_slice_data(shot, t, dname, cat),
    get_time_seriese_data(shot, t1, t2, dname, cat).
    Low-level: _eddbreadTime(shot, cat, dname, t1, t2), _eddbreadHeader(shot, cat, dname),
    _eddbreadOne(shot, cat, dname, step), _eddbreadPara(shot, cat, dname).
    Also: _eddbreadPrePro, _eddbreadImage, _eddbreadComment, _eddbreadScore,
    _eddbreadChInfo, _eddbreadTable, _eddbreadShot, _eddbreadNearTime.
    EDDB_remote_API mirrors local API for remote access.
    Higher-level tools: eGIS (graphical viewer), eSLICE (time slicer),
    eSURF (surface viewer) wrap EDAS channels.
  tree_organization: >-
    EDAS database at /analysis_DB/EDASDB/ with per-shot directories (a003846, etc.).
    8 database API modules: edas_eddb_api (main), edas_easy_api (simplified),
    edas_fledd_api (FLEDD), edas_fsmd_api (FSMD), edas_lcdb_api (LCDB),
    edas_mbdb_api (MBDB), edas_pmdb_api (PMDB), edas_uddb_api (UDDB).
    AnalysisDB for processed results, ExperimentDB for raw measurements.
    Multiple database backends: EDDB, FLEDD, FSMD, LCDB, MBDB, PMDB, UDDB.
  key_tools:
    - edas_eddb_api
    - edas_easy_api
    - EDDB_locallib_API
    - EDDB_remote_API
    - eslice
    - esurf
    - egis
    - getseldata
    - FBEQU
    - SAEQU
    - TOPICS2
  wiki_signal_patterns:
    - EDAS channel ID tables
    - diagnostic parameter listings
    - Eddb API reference
    - EDAS database category (cat) listings
    - getseldata parameter documentation
    - eslice/esurf viewer documentation
  code_import_patterns:
    - import edas_eddb_api
    - import edas_easy_api
    - EDDB_locallib_API
    - EDDB_remote_API
    - eddb_get
    - eddbreadTime
    - eddbreadHeader
    - get_time_slice_data
    - get_time_nearest
    - opendb(
    - closedb(
    - import eddb
    - eslice
    - esurf
    - getseldata
  notes:
    - "EDAS2 v2.1.15 at /analysis/src/edas2/v2.1.15/ with edas_egis, edas_eslice2, edas_esurf2, edas_share"
    - "8 database API modules at edas_share/database_api/: eddb, easy, fledd, fsmd, lcdb, mbdb, pmdb, uddb"
    - "EDDB_locallib_API class: 25+ methods including opendb, closedb, get_time_nearest, get_time_slice_data"
    - "Low-level read methods: _eddbreadTime(shot,cat,dname,t1,t2), _eddbreadHeader(shot,cat,dname), _eddbreadOne, _eddbreadPara"
    - "EDASDB at /analysis_DB/EDASDB/ with shot directories (a003846, a003915, etc.)"
    - "Tools at /analysis/bin/: eslice, esurf, egis, getseldata, FBEQU, SAEQU, TOPICS2"
    - "C headers at /analysis/src/getseldata_v4.2/eddbaccess.h"
    - "IMAS/3.42.0, MDSplus/7.132.0, UDA/2.7.5-2.7.6 modules available"
    - "import imas works after module load (DD 3.42.0)"

# Discovery root paths for path discovery pipeline
# These are seeded as starting points for directory scanning
discovery_roots:
  - /home                          # User home directories
  - /analysis/src                  # Analysis source code
  - /analysis/bin                  # Analysis binaries and scripts
  - /analysis/data                 # Analysis data outputs
  - /analysis/manual               # Documentation
  - /work/edas                     # EDAS work area
  - /analysis_DB/EDASDB            # EDAS database
  - /analysis_DB/MBDB              # MB database

# Wiki/documentation sites
# JT60SA documentation is hosted on nakasvr23 behind IFERC VPN.
# Site 0: Live TWiki Main web - EDAS manuals, API docs, shot reports, daily reports (~5500 topics)
# Site 1: TWiki static export - analysis code documentation (Code web, ~285 topics)
# Site 2: Server landing page - hardware, software, login, batch jobs, compilers
#
# Access: Use browser URLs from port_forwards section when tunnels are active.
# Original URLs retained for documentation and direct VPN access.
wiki_sites:
  - name: twiki_main
    url: http://157.111.10.188/twiki
    site_type: twiki
    webs:
      - Main
    pub_path: /var/www/html/twiki/pub  # Artifact discovery via fd over SSH
    access_method: tunnel              # Use port forward (browser.services[twiki_main])
    auth_type: none
    ssh_available: true
    description: >-
      JT-60SA Main TWiki web via live Apache/CGI. Contains EDAS tool manuals
      (eGIS, eSLICE, eSURF), Eddb API documentation (C/Fortran/Python wrappers),
      AnalysisDB and ExperimentDB system docs, discharge parameter handbook,
      daily reports, shot reports, and operational reports.
      ~5500 topics, ~130 artifacts. Pages discovered via WebTopicList API,
      artifacts via fd scanning pub/<web>/ on the filesystem.
    languages:
      - ja
      - en

  - name: twiki_code
    url: https://nakasvr23.iferc.org/twiki_html
    portal_page: WebHome.html
    site_type: twiki_static
    pub_path: /var/www/html/twiki_html/rsrc  # Artifact discovery via fd over SSH
    access_method: tunnel              # Use port forward (browser.services[twiki_code])
    auth_type: none
    ssh_available: true
    description: >-
      JT-60SA Code web - analysis code documentation (standalone archive,
      no Code web in live TWiki). Contains TOPICS, EDAS, SLICE, equilibrium
      codes, hardware specs. Static HTML export, ~285 pages, ~644 artifacts.
      Mixed Japanese/English content.
    languages:
      - ja
      - en

  - name: server_docs
    url: https://nakasvr23.iferc.org
    portal_page: index-en.html
    site_type: static_html
    access_method: tunnel              # Use port forward (browser.services[server_docs])
    auth_type: none
    ssh_available: true
    description: >-
      JT-60SA data analysis server (nakasvr23) system documentation.
      Hardware specs, software list, login procedures, batch job usage,
      compiler configuration, file system layout. Bilingual (JP/EN).
    languages:
      - ja
      - en
    exclude_prefixes:
      - /twiki_html      # Separate TWiki site
      - /matlab          # MATLAB vendor documentation
      - /idl             # IDL vendor documentation
      - /pv-wave         # PV-WAVE vendor documentation
      - /analysis        # Analysis tools help (external)

# User info discovery configuration
user_info:
  name_format: last_first  # Japanese order: family name first (e.g., マッキントッシュ サイモン)
  lookup_tools:
    - getent
    - passwd
    - id

# =============================================================================
# Port Forwards - Local SSH tunnels for service access
# =============================================================================
# JT-60SA services are behind IFERC VPN. Access from workstation requires:
# 1. VPN active (OpenVPN to iferc.org)
# 2. SSH tunnels via autossh systemd service (jt60sa-twiki-forward.service)
#
# Port convention: base 88xx for jt60sa, last digit = wiki site index
# wiki_sites[0] -> port 8800, wiki_sites[1] -> port 8801, etc.
#
# The reverse tunnel (iter-reverse-tunnel.service) exposes these ports to ITER
# workers via RemoteForward, allowing discovery from both workstation and ITER.

port_forwards:
  port_base: 8800
  ssh_host: jt60sa  # SSH to jt60sa, then LocalForward to wiki servers
  forwards:
    - name: twiki_main
      local_port: 8800
      remote_host: 157.111.10.188
      remote_port: 80
      protocol: http
      description: JT-60SA Main TWiki web (live Apache/CGI, ~5500 topics)

    - name: twiki_code
      local_port: 8801
      remote_host: nakasvr23.iferc.org
      remote_port: 443
      protocol: https
      description: JT-60SA Code web static export (~285 pages)

    - name: server_docs
      local_port: 8802
      remote_host: nakasvr23.iferc.org
      remote_port: 443
      protocol: https
      description: nakasvr23 server documentation (hardware, software, login)

# =============================================================================
# Browser URLs - Localhost access with active port forwards
# =============================================================================
# These URLs work when the jt60sa-twiki-forward.service is running.
# From ITER workers, use the same URLs (iter-reverse-tunnel exposes them).

browser:
  services:
    - name: twiki_main
      url: http://localhost:8800/twiki
      description: Main TWiki web - EDAS manuals, API docs, shot reports

    - name: twiki_code
      url: https://localhost:8801/twiki_html
      description: Code web static - TOPICS, equilibrium codes, hardware specs

    - name: server_docs
      url: https://localhost:8802/
      description: Server documentation - login, batch jobs, compilers
