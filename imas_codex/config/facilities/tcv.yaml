# TCV Tokamak - Swiss Plasma Center (EPFL)
#
# Public facility configuration for graph and mappings.
# Infrastructure data is in tcv_private.yaml (gitignored).

facility: tcv
name: TCV Tokamak
machine: TCV
description: Swiss Plasma Center - TCV Tokamak at EPFL
location: Lausanne, Switzerland

# SSH connection (user configures ~/.ssh/config with this alias)
ssh_host: tcv

# Data systems available at this facility
data_systems:
  - mdsplus
  - tdi

# Discovery root paths for path discovery pipeline
# These are seeded as starting points for directory scanning
discovery_roots:
  - /home                          # User home directories
  - /home/codes                    # Shared analysis/modeling codes
  - /usr/local/CRPP/tdi            # TDI expression library
  - /usr/local/mdsplus/trees       # MDSplus tree definitions
  - /videoanalysis                 # Video analysis code
  - /videodata                     # Video data

# Data source configuration for signal discovery
# Used by: imas-codex discover signals tcv
data_sources:
  # TDI functions are the primary data access layer for TCV.
  # These .fun files define physics-level accessor functions that abstract
  # over raw MDSplus paths, handle versioning, and provide source selection.
  tdi:
    # Primary TDI directory (scanned for signal discovery)
    primary_path: /usr/local/CRPP/tdi/tcv  # Physics accessors: tcv_eq, tcv_get, tcv_ip
    # Reference shot for TDI accessor validation
    reference_shot: 85000
    # Hardware control and operational functions to exclude from signal discovery.
    # These functions may load missing shared libraries (e.g., libvaccess.so),
    # print debug output to stdout, or perform machine-control actions.
    exclude_functions:
      # Hardware / vacuum / tile thermocouple control
      - tile_store
      - tile_init_action
      - tile_cycle
      - tile_counter
      - tile_status
      # Acquisition / triggering
      - acq_lente_trigger
      - acq_lente_init
      # Beckhoff PLC / hardware state
      - beckhoff_setstate
      - beckhoff_getstate
      # Shot management / sequencing
      - shot_close
      - shot_open
      - shot_init
      # Initialization / action dispatch (void functions)
      - init_action
      - close_action
      - store_action

  # MDSplus configuration for signal discovery and data validation.
  # The tcv_shot tree contains 13 subtrees (83k+ nodes total).
  # Physics-relevant subtrees are scanned for signal discovery;
  # hardware/acquisition trees (ATLAS=35k nodes) and real-time control
  # trees (PCS=15k, APCS) are skipped due to size and low physics signal
  # density. HYBRID (16k nodes, mostly internal heating parameters) is
  # scanned despite size since it contains relevant heating scenarios.
  mdsplus:
    connection_tree: tcv_shot  # Default tree for TDI context
    reference_shot: 85000
    # Source MDSplus environment (sets PYTHONPATH for MDSplus Python bindings)
    setup_commands:
      - source /etc/profile.d/mdsplus.sh
    # Subtrees to scan for signal discovery.
    # Each is opened as a separate MDSplus tree.
    trees:
      - results      # Equilibrium, analysis outputs (~1500 signals w/ data)
      - magnetics    # Magnetic field measurements (~215 signals)
      - diagz        # Diagnostic measurements (~220 signals)
      - base         # Core plasma parameters (~287 signals)
      - ecrh         # Electron cyclotron heating (~416 signals)
      - power        # Power supply data
      - diag_act     # Diagnostic actions
      - manual       # Manually-populated signals
      - vsystem      # Vista control parameters
      - hybrid       # Hybrid heating scenarios (16k nodes but physics-relevant)
    # Node usage types to include. SIGNAL is physics measurements,
    # NUMERIC includes computed/processed values and calibration data.
    # Many diagnostic trees store real data under NUMERIC usage.
    node_usages:
      - SIGNAL
      - NUMERIC
    # All subtrees (including hardware/control, not scanned)
    subtrees:
      - ATLAS         # Raw acquisition hardware (35k nodes - skip)
      - BASE
      - DIAGZ
      - DIAG_ACT
      - ECRH
      - HYBRID        # Hybrid heating internals (16k nodes - skip)
      - MAGNETICS
      - MANUAL
      - POWER
      - RESULTS
      - VSYSTEM
      - PCS           # Plasma control system (15k nodes - skip)
      - APCS
    # Skip metadata nodes that are not physics signals
    exclude_node_names:
      - COMMENTS
      - DATE
      - LAST_TRIAL
      - OK_TRIALINDX
      - USER_TRIAL
      - SUBCALL
      - ROUTINE
      - VERSION_NUM
      - CONFIDENCE
      - ERROR_BAR
      - IGNORE
      - FOO
      - NODES_USED
      - TEST
      - TRIAL
    # Static/machine-description trees containing time-invariant constructional data.
    # These are separate MDSplus trees (not subtrees of tcv_shot) versioned by
    # machine configuration changes. The STATIC tree was not discovered by signal
    # discovery because it is not a subtree of tcv_shot â€” it is an independent
    # tree opened by version number (shot=1..8), not by experimental shot number.
    # Data is accessed via the TDI function static("tag")[$shot] which auto-selects
    # the correct version based on the currently open experimental shot.
    static_trees:
      - tree_name: static
        accessor_function: static
        extract_values: true
        versions:
          - version: 1
            first_shot: 1
            description: Original configuration
          - version: 2
            first_shot: 13551
            description: Belt limiter removed
          - version: 3
            first_shot: 49829
            description: NBH ports added
          - version: 4
            first_shot: 63053
            description: 1st-gen HFS baffle only (SI-NO)
          - version: 5
            first_shot: 63528
            description: 1st-gen HFS and LFS baffles (SI-LO)
          - version: 6
            first_shot: 65794
            description: Un-baffled (with port protection tiles)
          - version: 7
            first_shot: 70972
            description: 1st-gen HFS and 2nd-gen LFS baffles (SI-SO)
          - version: 8
            first_shot: 74971
            description: 2nd-gen HFS and 1st-gen LFS baffles (LI-LO)
        systems:
          - symbol: W
            name: Individual coil turns
            size: 830
            parameters: [R, Z, W, H, A, NA, NB, NT, N, XSECT]
          - symbol: C
            name: Poloidal field coils
            description: "Coils as groups: A,B1,B2,C1,C2,D1,D2,E's,F's,G's"
            size: 29
            parameters: [R, Z, W, H, DIM, ANG, INOM, UNOM]
          - symbol: A
            name: Coils as connected
            description: "Connected coil groups: OH1,OH2,E's,F's,G"
            size: 19
            parameters: [R, Z, DIM]
          - symbol: V
            name: Vessel filaments
            size: 256
            parameters: [R, Z, ANG, RHO, PERIM, DIM]
          - symbol: E
            name: Vessel eigenmodes
            size: 256
            parameters: [TAU]
          - symbol: E0
            name: Symmetric vessel eigenmodes
            size: 128
          - symbol: F
            name: Flux loops
            description: 38 vessel flux loops + 23 coil flux loops
            size: 61
            parameters: [R, Z, ANG, DIM]
          - symbol: M
            name: Magnetic probes
            size: 38
            parameters: [R, Z, ANG, DIM]
          - symbol: X
            name: Fine poloidal mesh
            size: 1885
            parameters: [R, Z]
          - symbol: XC
            name: Coarse poloidal mesh
            size: 495
            parameters: [R, Z]
          - symbol: T
            name: Tile contour
            size: 512
            parameters: [R, Z, S, DIM]

# Data access patterns discovered during facility exploration.
# Informs wiki scoring, code ingestion, and signal discovery.
data_access_patterns:
  primary_method: tdi
  shot_identifier: shot
  signal_naming: >-
    TDI function dispatch: tcv_eq('quantity', source='LIUQE'),
    tcv_get('signal_name'), or direct functions like fir_aut(shot).
    Raw MDSplus paths use backslash notation: \tree::subtree:node.
  tree_organization: >-
    MDSplus subtrees: ATLAS, BASE, DIAGZ, DIAG_ACT, ECRH, HYBRID,
    MAGNETICS, MANUAL, POWER, RESULTS, VSYSTEM, PCS, APCS.
    TDI subdirs at /usr/local/CRPP/tdi/: base, devices, python,
    scopes, tcv, trees, vsystem. TDI functions abstract over
    MDSplus trees with automatic path resolution.
  key_tools:
    - tdiExecute
    - tcv_get
    - tcv_eq
    - gdat
    - tcvget
    - fir_aut
    - MDSplus
  wiki_signal_patterns:
    - MDSplus path tables
    - diagnostic node listings
    - signal catalogs with units
    - TDI function documentation
    - MDSplus subtree references (ATLAS, DIAGZ, MAGNETICS, etc.)
  code_import_patterns:
    - import MDSplus
    - from MDSplus import
    - tdiExecute
    - tcv_get
    - gdat(
    - tcv_eq(
    - fir_aut(
  notes:
    - "13 MDSplus subtrees found via SSH: ATLAS BASE DIAGZ DIAG_ACT ECRH HYBRID MAGNETICS MANUAL POWER RESULTS VSYSTEM PCS APCS"
    - "TDI library at /usr/local/CRPP/tdi/ with subdirs: base devices python scopes tcv trees vsystem"
    - "Primary TDI physics accessors in /usr/local/CRPP/tdi/tcv/"
    - "/home/codes NFS too slow for broad search - known issue"

# Wiki/documentation sites
# Direct HTTP access via Tequila SSO (EPFL authentication)
# Set credentials: imas-codex credentials set tcv-wiki
wiki_sites:
  - url: https://spcwiki.epfl.ch/wiki
    portal_page: Portal:TCV
    site_type: mediawiki
    access_method: direct  # Accessible from internet
    auth_type: tequila     # EPFL Tequila SSO
    credential_service: tcv
    ssh_available: true    # SSH tunnel also possible via tcv host

# User info discovery configuration
# GECOS = General Comprehensive Operating System (5th field in /etc/passwd)
user_info:
  name_format: first_last  # Standard "First Last" format
  lookup_tools:  # Ordered fallback list
    - getent   # POSIX standard, includes LDAP/NIS/SSSD
    - passwd   # /etc/passwd fallback
    - id       # existence check only