# IMAS Data Dictionary Knowledge Graph Schema
#
# This schema defines the graph representation of the IMAS Data Dictionary,
# enabling version tracking, compliance checking, and cross-linking with
# facility-specific data.
#
# Design follows the "Super Tree" pattern from MDSplus ingestion:
# - Store unified graph with applicability ranges (introduced/deprecated versions)
# - Augment rather than rebuild (shared with facility knowledge)
#
# Generated models: imas_codex/graph/models.py
# To regenerate: uv run build-models --force
#
# See plans/IMAS_DD_GRAPH.md for design decisions and rationale.

id: https://imas.iter.org/schemas/imas_dd
name: imas_dd
title: IMAS Data Dictionary Knowledge Graph Schema
description: >-
  Graph representation of the IMAS Data Dictionary with version tracking,
  coordinate linking, and semantic clustering.

license: MIT
version: 0.4.0

prefixes:
  linkml: https://w3id.org/linkml/
  imas_dd: https://imas.iter.org/schemas/imas_dd/
  imas: https://imas.iter.org/

default_prefix: imas_dd
default_range: string

imports:
  - linkml:types
  - common

# =============================================================================
# Enums
# =============================================================================

enums:
  DDDataType:
    description: IMAS Data Dictionary data types
    permissible_values:
      STR_0D:
        description: Scalar string
      STR_1D:
        description: 1D array of strings
      INT_0D:
        description: Scalar integer
      INT_1D:
        description: 1D array of integers
      INT_2D:
        description: 2D array of integers
      INT_3D:
        description: 3D array of integers
      FLT_0D:
        description: Scalar float
      FLT_1D:
        description: 1D array of floats
      FLT_2D:
        description: 2D array of floats
      FLT_3D:
        description: 3D array of floats
      FLT_4D:
        description: 4D array of floats
      FLT_5D:
        description: 5D array of floats
      FLT_6D:
        description: 6D array of floats
      CPX_0D:
        description: Scalar complex
      CPX_1D:
        description: 1D array of complex
      CPX_2D:
        description: 2D array of complex
      CPX_3D:
        description: 3D array of complex
      CPX_4D:
        description: 4D array of complex
      CPX_5D:
        description: 5D array of complex
      STRUCTURE:
        description: Container structure (no data)
      STRUCT_ARRAY:
        description: Array of structures

  DDNodeType:
    description: Time-variation character of DD nodes
    permissible_values:
      dynamic:
        description: Data varying in time within the IDS
      constant:
        description: Data not varying within the IDS
      static:
        description: Data not varying between IDSs
      none:
        description: No time-variation character assigned

  COCOSLabelTransformation:
    description: >-
      COCOS transformation labels from the DD XML cocos_label_transformation
      attribute. Each label identifies a class of fields that transform
      together under COCOS sign changes (e.g., all psi_like fields flip
      sign between COCOS 11 and 17).
    permissible_values:
      psi_like:
        description: Poloidal flux (ψ) and related quantities
      dodpsi_like:
        description: Derivatives with respect to ψ (dX/dψ)
      ip_like:
        description: Plasma current and related quantities
      b0_like:
        description: Toroidal magnetic field and related quantities
      q_like:
        description: Safety factor and related quantities
      tor_angle_like:
        description: Toroidal angle (φ) and related quantities
      pol_angle_like:
        description: Poloidal angle (θ) and related quantities
      one_like:
        description: Quantities with unit transformation factor
      grid_type_dim1_like:
        description: Grid dimension 1 coordinate
      grid_type_dim2_like:
        description: Grid dimension 2 coordinate
      grid_type_dim1_dim1_like:
        description: Grid dimension 1×1 tensor component
      grid_type_dim1_dim2_like:
        description: Grid dimension 1×2 tensor component
      grid_type_dim1_dim3_like:
        description: Grid dimension 1×3 tensor component
      grid_type_dim2_dim2_like:
        description: Grid dimension 2×2 tensor component
      grid_type_dim2_dim3_like:
        description: Grid dimension 2×3 tensor component
      grid_type_dim3_dim3_like:
        description: Grid dimension 3×3 tensor component
      grid_type_tensor_covariant_like:
        description: Covariant tensor component
      grid_type_tensor_contravariant_like:
        description: Contravariant tensor component

  LifecycleStatus:
    description: >-
      IMAS Data Dictionary lifecycle status for IDS and field definitions.
      Extracted from the lifecycle_status XML attribute.
    permissible_values:
      active:
        description: Stable, actively maintained definition
      alpha:
        description: Experimental definition, subject to change
      obsolescent:
        description: Deprecated definition, scheduled for removal

  IDSType:
    description: >-
      IMAS IDS temporal classification from the DD XML type attribute.
    permissible_values:
      dynamic:
        description: IDS containing time-varying data
      constant:
        description: IDS containing data constant over a pulse

  PhysicsDomainDD:
    description: Physics domains for IMAS data paths
    permissible_values:
      equilibrium:
        description: Equilibrium reconstruction and MHD equilibrium
      core_profiles:
        description: Core plasma profiles (Te, Ti, ne)
      edge_profiles:
        description: Edge and SOL plasma profiles
      transport:
        description: Transport coefficients and fluxes
      mhd:
        description: MHD stability and instabilities
      waves:
        description: Wave heating and current drive
      particles:
        description: Energetic particles and neutrals
      diagnostics:
        description: Diagnostic measurements
      engineering:
        description: Machine and engineering systems
      control:
        description: Plasma control systems
      general:
        description: General/unclassified

  ChangeType:
    description: Types of metadata changes between DD versions
    permissible_values:
      units:
        description: Units changed
      documentation:
        description: Documentation text changed
      type:
        description: Data type or node type changed
      coordinates:
        description: Coordinate specification changed
      lifecycle:
        description: Lifecycle status changed (e.g., obsolete)
      maxoccur:
        description: Maximum occurrences changed
      node_type:
        description: Time-variation character (node type) changed
      data_type:
        description: Data type changed (e.g., FLT_1D to FLT_2D)
      cocos_label_transformation:
        description: COCOS transformation label changed (e.g., field gained or lost COCOS sensitivity)
      lifecycle_status:
        description: Lifecycle status changed (e.g., alpha to active)
      timebasepath:
        description: Time base path reference changed

  SemanticChangeType:
    description: Physics significance of documentation changes
    permissible_values:
      sign_convention:
        description: Sign or orientation convention change (affects data interpretation)
      coordinate_convention:
        description: Coordinate system or reference frame change
      definition_clarification:
        description: More precise definition without semantic change
      none:
        description: No physics significance detected

# =============================================================================
# Classes
# =============================================================================

classes:
  DDVersion:
    description: >-
      A version of the IMAS Data Dictionary. Versions form a chain via
      PREDECESSOR relationships, enabling traversal of DD evolution.
      
      Embedding metadata tracks when embeddings were generated for this version,
      enabling cache validation and incremental updates.
    class_uri: imas_dd:DDVersion
    attributes:
      id:
        identifier: true
        description: Version string (e.g., "3.42.2", "4.0.0")
        required: true
      release_date:
        description: Release date of this DD version
        range: datetime
      is_current:
        description: Whether this is the current/latest version
        range: boolean
      path_count:
        description: Total number of paths in this version
        range: integer
      ids_count:
        description: Number of IDS definitions in this version
        range: integer
      predecessor:
        description: Previous DD version
        range: DDVersion
      # Embedding generation metadata
      embeddings_built_at:
        description: Timestamp when embeddings were generated for this version
        range: datetime
      embeddings_model:
        description: Model name used for embedding generation
      embeddings_count:
        description: Number of paths with embeddings in this version
        range: integer
      clusters_built_at:
        description: Timestamp when clusters were generated for this version
        range: datetime
      clusters_count:
        description: Number of clusters for this version
        range: integer
      cocos:
        description: >-
          COCOS convention for this DD version, extracted from the DD XML
          root <cocos> element. Values: 11 for DD 3.x (from 3.35.0), 17
          for DD 4.x. Null for versions before 3.35.0 where the XML did
          not declare COCOS.
        range: integer
      cocos_labeled_fields:
        description: >-
          Number of fields in this DD version that have a
          cocos_label_transformation attribute in the XML. Tracks the
          growth of COCOS annotation coverage across versions.
        range: integer
      has_cocos:
        description: >-
          Link to the COCOS node for this DD version. Enables graph traversal
          to find all entities sharing the same COCOS convention.
        range: COCOS
        annotations:
          relationship_type: HAS_COCOS
      build_hash:
        description: >-
          SHA256 hash of build parameters (DD versions, flags) for idempotency.
          If hash matches on next run, DD build is skipped. Replaces the
          former _GraphMeta.dd_build_hash property.
      created_at:
        description: Timestamp when DDVersion node was created in the graph
        range: datetime

  IDS:
    description: >-
      A top-level Interface Data Structure definition. IDS nodes are the
      root containers for physics data (e.g., equilibrium, core_profiles).
    class_uri: imas_dd:IDS
    attributes:
      name:
        identifier: true
        description: IDS name (e.g., "equilibrium", "core_profiles")
        required: true
      description:
        description: IDS description from DD documentation
      physics_domain:
        description: Primary physics domain
        range: PhysicsDomain
      path_count:
        description: Number of paths in this IDS (current version)
        range: integer
      leaf_count:
        description: Number of leaf nodes (data endpoints)
        range: integer
      max_depth:
        description: Maximum hierarchy depth
        range: integer
      documentation_coverage:
        description: Fraction of paths with documentation (0.0-1.0)
        range: float
      dd_version:
        description: Data Dictionary version string this IDS definition belongs to
      lifecycle_status:
        description: >-
          Lifecycle maturity status from the DD XML (active or alpha).
          Active IDS are stable; alpha IDS are experimental.
        range: LifecycleStatus
      lifecycle_version:
        description: >-
          DD version where this IDS was first introduced, as recorded in
          the DD XML lifecycle_version attribute.
      lifecycle_last_change:
        description: >-
          DD version where this IDS definition was last modified, as recorded
          in the DD XML lifecycle_last_change attribute.
      ids_type:
        description: >-
          Temporal classification of the IDS (dynamic or constant), from the
          DD XML type attribute.
        range: IDSType
      introduced_version:
        description: DD version where this IDS was introduced
        range: DDVersion
        annotations:
          relationship_type: INTRODUCED_IN
      deprecated_version:
        description: DD version where this IDS was deprecated (null = current)
        range: DDVersion
        annotations:
          relationship_type: DEPRECATED_IN

  IMASPath:
    description: >-
      An IMAS Data Dictionary path. Represents any level from IDS root
      (e.g., "equilibrium") to leaf nodes (e.g., "equilibrium/time_slice/boundary/psi").
      Paths form a hierarchy via PARENT relationships and link to units,
      coordinates, and semantic clusters. Version tracking uses
      INTRODUCED_IN/DEPRECATED_IN/RENAMED_TO relationships.
      
      Error field paths (e.g., psi_error_upper) are linked to their data paths
      via HAS_ERROR relationships. This allows semantic search to find the
      primary data path without embedding redundant error field descriptions.
      
      This is the single authoritative representation of IMAS paths - code
      references should link to existing IMASPath nodes, never create them
      on-demand.
      
      Embedding Support:
      - embedding_text: Pre-concatenated context for embedding generation
      - embedding: 256-dim vector (model tracked on DDVersion)
      - embedding_hash: Content hash for cache busting
      - Both active and deprecated data paths are embedded for evolution queries
      - Error fields and metadata paths are excluded from embedding
      - GGD paths are included by default (configurable)
    class_uri: imas_dd:IMASPath
    attributes:
      id:
        identifier: true
        description: Full path (e.g., "equilibrium/time_slice/boundary/psi")
        required: true
      name:
        description: Leaf name (last path component, e.g., "psi")
        required: true
      ids:
        description: IDS name (root of path hierarchy, e.g., "equilibrium")
        required: true
      documentation:
        description: Documentation string from DD
      data_type:
        description: Data type (e.g., FLT_1D, STR_0D, STRUCTURE)
        range: DDDataType
      ndim:
        description: Number of dimensions (0-6)
        range: integer
      node_type:
        description: Time-variation type (dynamic/constant/static)
        range: DDNodeType
      physics_domain:
        description: Physics domain (derived from path/IDS)
        range: PhysicsDomain
      maxoccur:
        description: Maximum occurrences (for struct arrays)
        range: integer
      cocos_label_transformation:
        description: >-
          COCOS transformation label from the DD XML. Identifies which class
          of COCOS transformation applies to this field (e.g., psi_like fields
          flip sign between COCOS 11 and 17). Null for fields without COCOS
          sensitivity. Extracted from the cocos_label_transformation XML attribute.
        range: COCOSLabelTransformation
      lifecycle_status:
        description: >-
          Lifecycle maturity status from the DD XML (alpha or obsolescent).
          Only set on fields with non-default lifecycle status. Null means
          the field inherits the IDS-level lifecycle status.
        range: LifecycleStatus
      lifecycle_version:
        description: >-
          DD version where this field's lifecycle status was set, from the
          DD XML lifecycle_version attribute.
      timebasepath:
        description: >-
          Path to the time array for this dynamic field, from the DD XML
          timebasepath attribute. Tells data access code where to find the
          time coordinate (e.g., "time" or "../time").
      path_doc:
        description: >-
          Human-readable path with index notation from the DD XML path_doc
          attribute (e.g., "time_slice(itime)/boundary/psi"). Differs from
          the machine-readable path used as the node ID.
      introduced_after_version:
        description: >-
          DD version after which this field was introduced, from the DD XML
          introduced_after_version attribute. Null for fields present since
          the IDS was created.
      change_nbc_version:
        description: >-
          DD version where a non-backward-compatible change was made to this
          field, from the DD XML change_nbc_version attribute.
      change_nbc_description:
        description: >-
          Description of the non-backward-compatible change (e.g.,
          "leaf_renamed", "type_changed"), from the DD XML.
      change_nbc_previous_name:
        description: >-
          Previous name of this field before a non-backward-compatible rename,
          from the DD XML change_nbc_previous_name attribute.
      url:
        description: >-
          URL to documentation or reference material for this field, from the
          DD XML url attribute. May be a relative path to IMAS docs or an
          absolute URL.
      # Relationships
      parent_path:
        description: Parent path in hierarchy (null for IDS-level paths)
        range: IMASPath
        annotations:
          relationship_type: HAS_PARENT
      in_ids:
        description: IDS that contains this path
        range: IDS
        annotations:
          relationship_type: IN_IDS
      unit:
        description: Physical units for this path
        range: Unit
        annotations:
          relationship_type: HAS_UNIT
      introduced_version:
        description: DD version where this path was introduced
        range: DDVersion
        annotations:
          relationship_type: INTRODUCED_IN
      deprecated_version:
        description: DD version where this path was deprecated (null = current)
        range: DDVersion
        annotations:
          relationship_type: DEPRECATED_IN
      renamed_to:
        description: Successor path if this was renamed (not just removed)
        range: IMASPath
      identifier_schema:
        description: Identifier schema if this is an identifier field
        range: IdentifierSchema
        annotations:
          relationship_type: HAS_IDENTIFIER_SCHEMA
      # Embedding fields for semantic search
      embedding_text:
        description: >-
          Pre-concatenated context for embedding: combines IDS description,
          parent path context, documentation, units, and coordinates into
          natural language prose optimized for sentence transformer embedding.
      embedding:
        description: >-
          256-dim embedding vector. Model tracked on DDVersion.embeddings_model.
          Use Neo4j vector index for semantic search.
        multivalued: true
        range: float
      embedding_hash:
        description: >-
          SHA256 hash of embedding_text content. Used for cache busting - if hash
          changes, embedding needs regeneration. Enables minimal recompute on rebuild.
      # Error field linking (HAS_ERROR relationship with error_type property)
      error_paths:
        description: >-
          Error field paths linked via HAS_ERROR relationship. For data paths like
          "psi", links to error variants like "psi_error_upper", "psi_error_lower".
          The relationship has an error_type property ("upper", "lower", or "index").
          Error fields are not embedded since they have no unique semantic content.
        multivalued: true
        range: IMASPath
        annotations:
          relationship_type: HAS_ERROR
      in_cluster:
        description: Semantic cluster this path belongs to
        range: IMASSemanticCluster
        annotations:
          relationship_type: IN_CLUSTER
      coordinates:
        description: >-
          Coordinate specifications for this path (axis definitions).
          Can be index specs (1...N) or other paths (time, rho_tor, etc.).
        multivalued: true
        range: IMASCoordinateSpec
        annotations:
          relationship_type: HAS_COORDINATE

  # Unit is now defined in common.yaml and imported

  IMASCoordinateSpec:
    description: >-
      An index-based coordinate specification from the IMAS Data Dictionary
      (e.g., "1...N", "1...3"). Path references are handled via
      HAS_COORDINATE relationships to IMASPath nodes.
    class_uri: imas_dd:IMASCoordinateSpec
    attributes:
      id:
        identifier: true
        description: Coordinate spec string (e.g., "1...N", "1...3")
        required: true
      is_bounded:
        description: Whether the coordinate has a fixed maximum
        range: boolean
      max_size:
        description: Maximum size if bounded (e.g., 3 for "1...3")
        range: integer

  IMASSemanticCluster:
    description: >-
      A semantic cluster of related IMAS paths, derived from HDBSCAN
      clustering on path embeddings. Paths link to clusters via IN_CLUSTER.
      
      Embedding vectors enable fast cluster-based semantic search:
      query embedding is compared against cluster embeddings first, then
      individual paths within matching clusters are searched.
    class_uri: imas_dd:IMASSemanticCluster
    attributes:
      id:
        identifier: true
        description: Cluster identifier (UUID string)
        required: true
      label:
        description: LLM-generated semantic label (e.g., "boundary geometry")
        required: true
      description:
        description: Extended description of the cluster concept
      physics_domain:
        description: Primary physics domain of cluster members
        range: PhysicsDomain
      path_count:
        description: Number of paths in this cluster
        range: integer
      cross_ids:
        description: Whether cluster spans multiple IDS
        range: boolean
      representative_path:
        description: Most central path (closest to cluster center)
        range: IMASPath
      # Cluster embedding for semantic search
      embedding:
        description: >-
          Cluster centroid embedding vector (256-dim, L2-normalized).
          Mean of member path embeddings. Enables hierarchical search:
          first match clusters by embedding, then search within cluster.
        multivalued: true
        range: float
        annotations:
          vector_index_name: cluster_embedding
      label_embedding:
        description: >-
          Embedding of the LLM-generated cluster label text (256-dim).
          Enables natural language search by short physics concept name.
        multivalued: true
        range: float
        annotations:
          vector_index_name: cluster_label_embedding
      description_embedding:
        description: >-
          Embedding of the LLM-generated cluster description (256-dim).
          Primary vector for natural language cluster search — richer
          semantic content than label or centroid embeddings.
        multivalued: true
        range: float
        annotations:
          vector_index_name: cluster_description_embedding
      similarity_score:
        description: Average intra-cluster cosine similarity (0-1)
        range: float
      scope:
        description: Cluster scope (global, domain, or ids)
      scope_detail:
        description: Domain name or IDS name for domain/ids scopes
      ids_names:
        description: List of IDS names represented in this cluster
        multivalued: true
      # Enrichment metadata
      physics_concepts:
        description: Physics concepts covered by this cluster
        multivalued: true
      mapping_relevance:
        description: Relevance for IMAS mapping (high, medium, low)

  IdentifierSchema:
    description: >-
      An enumeration/identifier schema from the Data Dictionary. Represents
      a typed vocabulary of valid values for identifier fields (e.g.,
      coordinate_identifier, magnetics_probe_type_identifier). Options are
      stored as JSON for flexible querying. Extracted from the imas-python
      identifier_enum metadata API.
    class_uri: imas_dd:IdentifierSchema
    attributes:
      name:
        identifier: true
        description: >-
          Schema name (e.g., "coordinate_identifier",
          "magnetics_probe_type_identifier")
        required: true
      description:
        description: Schema description
      option_count:
        description: Number of valid options in this schema
        range: integer
      options:
        description: >-
          JSON-encoded list of {index, name} for each valid option value.
          Index is the integer identifier, name is the string label.
      field_count:
        description: Number of IMASPath fields using this identifier schema
        range: integer
      source:
        description: >-
          Source XML file for this identifier schema (e.g.,
          "utilities/coordinate_identifier.xml")

  IMASPathChange:
    description: >-
      Records a change to path metadata between DD versions.
      Enables tracking of documentation updates, unit changes, etc.
    class_uri: imas_dd:IMASPathChange
    attributes:
      id:
        identifier: true
        description: Composite key (path:change_type:version)
        required: true
      change_type:
        description: Type of change
        range: ChangeType
        required: true
      old_value:
        description: Previous value (as string)
      new_value:
        description: New value (as string)
      semantic_type:
        description: Physics significance (for documentation changes)
        range: SemanticChangeType
      keywords_detected:
        description: JSON array of significant keywords found in new value
      path:
        description: The path that changed
        range: IMASPath
        required: true
        annotations:
          relationship_type: FOR_IMAS_PATH
      version:
        description: Version where the change occurred
        range: DDVersion
        required: true
        annotations:
          relationship_type: IN_VERSION

  # Relationship class for coordinates (captures dimension + properties)
  CoordinateRelationship:
    description: >-
      Represents a coordinate relationship between an IMASPath and its coordinate
      (either another IMASPath or an IMASCoordinateSpec). Stored as relationship properties.
    class_uri: imas_dd:CoordinateRelationship
    attributes:
      dimension:
        description: Which dimension this coordinate applies to (1-6)
        range: integer
        required: true
      alternative:
        description: Whether this is an OR alternative coordinate
        range: boolean
      same_as:
        description: Whether from coordinate_same_as attribute
        range: boolean
      source_path:
        description: The path that has this coordinate
        range: IMASPath
        required: true
      target_path:
        description: The coordinate path (for path references)
        range: IMASPath
      target_spec:
        description: The coordinate spec (for index coordinates)
        range: IMASCoordinateSpec

  # Relationship class for cluster membership
  ClusterMembership:
    description: >-
      Represents membership of an IMASPath in a IMASSemanticCluster.
      Distance indicates proximity to cluster center.
    class_uri: imas_dd:ClusterMembership
    attributes:
      path:
        description: The member path
        range: IMASPath
        required: true
      cluster:
        description: The cluster
        range: IMASSemanticCluster
        required: true
      distance:
        description: Distance to cluster center (lower = more central)
        range: float
