# Facility Configuration Schema
#
# Defines the structure of per-facility YAML config files (tcv.yaml, jet.yaml, etc.).
# Validates both public and private configuration sections.
#
# Public config: <facility>.yaml (git-tracked, visible to LLMs/agents)
# Private config: <facility>_private.yaml (gitignored, infrastructure secrets)
#
# Generated models: imas_codex/config/models.py
# To regenerate: uv run build-models --force
#
# Usage:
#   from imas_codex.config.models import FacilityConfig
#   config = FacilityConfig.model_validate(yaml_data)

id: https://imas.iter.org/schemas/facility_config
name: facility_config
title: Facility Configuration Schema
description: >-
  Schema for per-facility YAML configuration files. Defines required and
  optional fields for both public and private config sections. Agents should
  edit these files via MCP tools (update_facility_infrastructure, add_exploration_note)
  which enforce this schema.

license: MIT
version: 0.4.0

prefixes:
  linkml: https://w3id.org/linkml/
  fc: https://imas.iter.org/schemas/facility_config/

default_prefix: fc
default_range: string

imports:
  - linkml:types

# =============================================================================
# Enums
# =============================================================================

enums:
  DataSystemType:
    description: Types of data systems available at facilities
    permissible_values:
      mdsplus:
        description: MDSplus tree-based data system
      tdi:
        description: TDI function-based data access layer
      uda:
        description: Universal Data Access (UDA) system
      imas:
        description: IMAS native data format
      ppf:
        description: JET Processed Pulse File system
      edas:
        description: JT-60SA EDAS data system
      hdf5:
        description: HDF5 file-based storage
      netcdf:
        description: NetCDF scientific data format

  LocalForwardProtocol:
    description: Protocol for local port forwards
    permissible_values:
      http:
        description: HTTP (plain)
      https:
        description: HTTPS (TLS)
      ssh:
        description: SSH tunnel endpoint

  WikiSiteType:
    description: Types of wiki/documentation sites
    permissible_values:
      mediawiki:
        description: MediaWiki-based sites (Wikipedia, SPCwiki)
      confluence:
        description: Atlassian Confluence
      twiki:
        description: TWiki/Foswiki installation
      twiki_static:
        description: TWiki static HTML export
      static:
        description: Static HTML documentation site
      static_html:
        description: Static HTML site (alias for static)

  WikiAuthType:
    description: Authentication methods for wiki sites
    permissible_values:
      none:
        description: No authentication required
      tequila:
        description: EPFL Tequila SSO
      keycloak:
        description: Keycloak OIDC (JET)
      basic:
        description: HTTP Basic authentication
      session:
        description: Session-based auth (login form, cookies)
      ssh_proxy:
        description: Access only via SSH tunnel

  NameFormat:
    description: Format of user names in GECOS field
    permissible_values:
      first_last:
        description: First Last format
      last_first:
        description: Last, First format
      username:
        description: Username only (no real name)

# =============================================================================
# Classes - Config File Structure
# =============================================================================

classes:
  # -------------------------------------------------------------------------
  # Public Config (in <facility>.yaml)
  # -------------------------------------------------------------------------

  FacilityConfig:
    description: >-
      Root configuration for a facility. Combines public and private fields.
      Public fields go in <facility>.yaml, private in <facility>_private.yaml.
      Validation merges both files before checking required fields.
      
      Note: The loader renames 'facility' to 'id', so either is accepted.
    class_uri: fc:FacilityConfig
    tree_root: true
    attributes:
      # --- Facility identifier (one of these is required) ---
      facility:
        description: Facility identifier in YAML files (e.g., "tcv", "jet")
      id:
        description: Facility identifier after loading (alias of facility)
      name:
        description: Human-readable facility name
        required: true
      machine:
        description: Tokamak/stellarator machine name
        required: true
      description:
        description: Brief facility description

      # --- Optional public fields ---
      location:
        description: Geographic location
      ssh_host:
        description: SSH host alias for connection (configured in ~/.ssh/config)
      data_systems:
        description: >-
          Data systems available. Can be list of strings ["mdsplus", "uda"]
          or dict with details {mdsplus: {available: true, ...}}.

      # --- Nested config sections ---
      discovery_roots:
        description: >-
          Root paths for discovery pipeline seeding. Can be simple strings
          ["/home", "/work"] or structured [{path: "/home", category: "container"}].
      data_sources:
        description: Data source configuration for signal discovery
        range: DataSourcesConfig
      data_access_patterns:
        description: >-
          Data access patterns discovered during initial facility exploration.
          Populated by exploration agents before signal discovery runs. Describes
          how data is organized, what tools/APIs exist, what naming conventions
          are used. This informs downstream tools (wiki scoring, signal extraction,
          code ingestion) about what to look for at this facility.
        range: DataAccessPatternsConfig
      wiki_sites:
        description: Wiki/documentation sites
        multivalued: true
        range: WikiSiteConfig
      user_info:
        description: User info discovery configuration
        range: UserInfoConfig
      port_forwards:
        description: >-
          Port forward configuration for accessing facility services from workstation.
          Each facility uses a base port range (e.g., 88xx for jt60sa). Individual
          services increment the last digit (0=wiki1, 1=wiki2, etc). Workstation
          SSH config establishes LocalForwards; autossh systemd services maintain them.
        range: PortForwardsConfig
      browser:
        description: >-
          Browser-accessible URLs for facility services accessible via port forwards.
          Maps service names to localhost URLs for documentation and quick access.
        range: BrowserConfig

      # --- Private fields (in <facility>_private.yaml) ---
      hostnames:
        description: Network hostnames for this facility
        multivalued: true
        annotations:
          is_private: true
      nfs_mounts:
        description: NFS mount points (list of {source, target, options})
        annotations:
          is_private: true
      paths:
        description: Key filesystem paths (nested dict structure)
        annotations:
          is_private: true
      svn:
        description: SVN repository URLs
        annotations:
          is_private: true
      excludes:
        description: Paths/patterns to exclude during exploration
        annotations:
          is_private: true
      tools:
        description: Tool availability map (tool -> version)
        annotations:
          is_private: true
      os_info:
        description: Operating system details
        annotations:
          is_private: true
      python_info:
        description: Python environment details
        annotations:
          is_private: true
      compilers:
        description: Compiler availability
        annotations:
          is_private: true
      containers:
        description: Available container images
        annotations:
          is_private: true
      exploration_notes:
        description: Free-form exploration notes (timestamped)
        multivalued: true
        annotations:
          is_private: true

  # -------------------------------------------------------------------------
  # Nested Config Types
  # -------------------------------------------------------------------------

  DiscoveryRootConfig:
    description: >-
      Structured configuration for a discovery root path. Used in private
      configs to provide category and priority hints for discovery seeding.
      Public configs may use simple string paths instead.
    class_uri: fc:DiscoveryRootConfig
    attributes:
      path:
        description: Absolute filesystem path to seed
        required: true
      category:
        description: >-
          Discovery category for balanced seeding. Values: container, modeling_code,
          analysis_code, data_access, workflow, experimental_data, documentation.
      description:
        description: Brief description of what this root contains
      priority:
        description: Seeding priority (high, medium, low)
      expand_depth:
        description: Maximum depth to expand from this root
        range: integer

  WikiSiteConfig:
    description: >-
      Configuration for a wiki/documentation site. Used by wiki discovery
      to enumerate pages and artifacts.
    class_uri: fc:WikiSiteConfig
    attributes:
      name:
        description: >-
          Unique identifier for cross-referencing with port_forwards and browser config.
          Should match LocalForwardConfig.name and BrowserServiceConfig.name.
      url:
        description: Base URL of the wiki site (original URL, may require VPN)
        required: true
      portal_page:
        description: Main portal/landing page name (e.g., "Main_Page", "Portal:TCV")
        ifabsent: "Main_Page"
      description:
        description: Brief description of the wiki content
      site_type:
        description: Type of wiki software
        range: WikiSiteType
        ifabsent: "mediawiki"
      access_method:
        description: >-
          How the site is accessed. Values: direct (public), vpn (VPN required),
          tunnel (use port forward from browser config), ssh_tunnel (SSH only).
        ifabsent: "direct"
      auth_type:
        description: Authentication method
        range: WikiAuthType
        ifabsent: "none"
      credential_service:
        description: Keyring service name for credentials
      ssh_available:
        description: Whether SSH tunnel is available as fallback
        range: boolean

  DataSourcesConfig:
    description: >-
      Data source configuration for signal discovery. Specifies how to
      enumerate signals from each data system. Each key maps to a scanner
      plugin that knows how to extract signals from that data source type.
    class_uri: fc:DataSourcesConfig
    attributes:
      tdi:
        description: TDI function configuration (MDSplus TDI expression files)
        range: TDIConfig
      mdsplus:
        description: MDSplus tree configuration (direct tree traversal)
        range: MDSplusConfig
      ppf:
        description: JET PPF configuration (Processed Pulse Files)
        range: PPFConfig
      edas:
        description: JT-60SA EDAS configuration (Experiment Data Access System)
        range: EDASConfig
      hdf5:
        description: HDF5 file configuration
        range: HDF5Config
      imas:
        description: IMAS native data configuration
        range: IMASConfig

  TDIConfig:
    description: >-
      TDI function data source configuration. TDI (.fun) files provide
      physics-level accessor functions over raw MDSplus tree paths.
      Facility-specific (e.g., TCV tcv_eq, tcv_get, tcv_ip).
    class_uri: fc:TDIConfig
    attributes:
      primary_path:
        description: Primary TDI directory path (e.g., /usr/local/CRPP/tdi/tcv)
      additional_paths:
        description: Additional TDI directories to scan
        multivalued: true
      reference_shot:
        description: Reference shot for TDI accessor validation
        range: integer
      exclude_functions:
        description: >-
          TDI function names to exclude from signal discovery (case-insensitive).
          Hardware control, acquisition triggers, and operational dispatch functions
          that don't return physics data. These functions may load missing shared
          libraries, print debug output, or perform side effects when executed.
        multivalued: true

  MDSplusConfig:
    description: MDSplus data source configuration
    class_uri: fc:MDSplusConfig
    attributes:
      connection_tree:
        description: Default tree for TDI context
      trees:
        description: MDSplus tree names to scan
        multivalued: true
      reference_shot:
        description: Shot number for tree introspection
        range: integer

  PPFConfig:
    description: >-
      JET PPF (Processed Pulse File) data source configuration.
      PPF is organized as Owner/DDA/Dtype entries. Access via SAL REST API,
      MATLAB ppfget, IDL ppfget, or getdat CLI.
    class_uri: fc:PPFConfig
    attributes:
      sal_endpoint:
        description: SAL REST API endpoint URL
      reference_pulse:
        description: Reference pulse for signal validation
        range: integer
      default_owner:
        description: Default PPF data owner (e.g., "jetppf")
      exclude_ddas:
        description: DDA identifiers to exclude from discovery
        multivalued: true

  EDASConfig:
    description: >-
      JT-60SA EDAS (Experiment Data Access System) configuration.
      EDAS wraps proprietary data formats with C/Fortran/Python APIs.
      Signal definitions are in C header files and Python wrapper code.
    class_uri: fc:EDASConfig
    attributes:
      api_path:
        description: Path to EDAS API source files
      header_path:
        description: Path to EDAS C header files with signal definitions
      reference_shot:
        description: Reference shot for signal validation
        range: integer

  HDF5Config:
    description: HDF5 file data source configuration
    class_uri: fc:HDF5Config
    attributes:
      paths:
        description: HDF5 file/directory paths to scan
        multivalued: true

  IMASConfig:
    description: >-
      IMAS native data source configuration. Used at facilities with
      native IMAS backend support (ITER, JET post-migration, JT-60SA).
    class_uri: fc:IMASConfig
    attributes:
      backends:
        description: Available IMAS backends (e.g., mdsplus, hdf5, memory)
        multivalued: true
      db_name:
        description: IMAS database name
      reference_shot:
        description: Reference shot for IDS enumeration
        range: integer

  UserInfoConfig:
    description: >-
      Configuration for user info discovery. Specifies how to extract
      user names from system (GECOS field, LDAP, etc.).
    class_uri: fc:UserInfoConfig
    attributes:
      name_format:
        description: Format of user names in GECOS field
        range: NameFormat
        ifabsent: "first_last"
      lookup_tools:
        description: Ordered list of tools to try for name lookup
        multivalued: true
        ifabsent: "[getent, passwd, id]"

  ExcludesConfig:
    description: >-
      Exclusion patterns for discovery. Prevents scanning of large directories
      that would hang or produce low-value results.
    class_uri: fc:ExcludesConfig
    attributes:
      large_dirs:
        description: >-
          Directories that caused timeouts (absolute paths).
          Discovery skips these entirely.
        multivalued: true
      depth_limits:
        description: >-
          Per-path depth limits (map of path -> max_depth).
          Limits recursion in specific subtrees.
      patterns:
        description: >-
          Glob patterns to exclude (e.g., "**/node_modules", "**/.git").
          Applied during directory enumeration.
        multivalued: true

  DataAccessPatternsConfig:
    description: >-
      Data access patterns discovered during initial facility exploration.
      Populated by exploration agents to inform downstream discovery tools.
      Describes how shot data is organized, what APIs/tools exist, and what
      naming conventions are used at this facility. This bridges exploration
      knowledge to scanning/scoring tools.
    class_uri: fc:DataAccessPatternsConfig
    attributes:
      primary_method:
        description: >-
          The primary data access method at this facility (e.g., "tdi" for TCV,
          "ppf" for JET, "edas" for JT-60SA, "imas" for ITER). Informs which
          scanner plugin to run first.
      signal_naming:
        description: >-
          How signals are named at this facility. Free text describing the
          convention (e.g., "TDI function dispatch: tcv_eq('quantity')",
          "PPF hierarchy: owner/dda/dtype", "EDAS channels: eddb_get(channel)").
      shot_identifier:
        description: >-
          What the facility calls shots (e.g., "shot" at TCV, "pulse" at JET,
          "shot" at JT-60SA). Used to template data access patterns.
      tree_organization:
        description: >-
          How experimental data is organized (e.g., "MDSplus trees by subsystem",
          "PPF by diagnostic data area", "EDAS database tables").
      key_tools:
        description: >-
          Key data access tools/APIs discovered at the facility.
          E.g., ["sal", "ppfget", "getdat"] for JET,
          ["tdiExecute", "tcv_get", "gdat"] for TCV,
          ["eddb_get", "edgis", "eslice"] for JT-60SA.
        multivalued: true
      wiki_signal_patterns:
        description: >-
          Patterns observed in wiki pages that indicate signal documentation.
          E.g., ["MDSplus path tables", "diagnostic node listings", "signal catalogs"].
          Helps wiki discovery score pages with data access content higher.
        multivalued: true
      code_import_patterns:
        description: >-
          Import patterns that indicate data access code.
          E.g., ["import MDSplus", "from jet.data import sal", "import eddb"].
          Helps code ingestion identify data access files.
        multivalued: true
      notes:
        description: Free-form notes about data access at this facility
        multivalued: true

  PortForwardsConfig:
    description: >-
      Port forward configuration for accessing facility services from workstation.
      Each facility uses a base port range (e.g., 88xx for jt60sa). Individual services
      use ports within that range: port_base+0 for first wiki, port_base+1 for second, etc.
      This convention allows internal tracking of which ports belong to which machines.
    class_uri: fc:PortForwardsConfig
    attributes:
      port_base:
        description: >-
          Base port number for this facility (e.g., 8800 for jt60sa, 8810 for jet).
          All local ports for this facility fall within port_base to port_base+99.
          Different facilities use different hundreds to avoid conflicts.
        range: integer
        required: true
      ssh_host:
        description: >-
          SSH host alias to tunnel through. If different from facility's ssh_host,
          this specifies the intermediate hop (e.g., "iter" when facility is behind ITER).
      forwards:
        description: List of local port forwards to establish
        multivalued: true
        range: LocalForwardConfig

  LocalForwardConfig:
    description: >-
      Configuration for a single SSH local port forward (LocalForward in ssh_config).
      Maps a localhost port to a remote host:port accessible from the tunnel endpoint.
    class_uri: fc:LocalForwardConfig
    attributes:
      name:
        description: >-
          Service name for identification (e.g., "twiki_main", "twiki_code", "api").
          Used in browser config and logs.
        required: true
      local_port:
        description: >-
          Local port number on workstation (e.g., 8880). Should follow facility convention:
          port_base + service_index where wiki sites use indices 0, 1, 2, etc.
        range: integer
        required: true
      remote_host:
        description: >-
          Remote hostname accessible from SSH tunnel endpoint. Can be IP, hostname,
          or localhost if the service runs on the SSH target host itself.
        required: true
      remote_port:
        description: Remote port number (e.g., 80 for HTTP, 443 for HTTPS)
        range: integer
        required: true
      protocol:
        description: Protocol for documentation and browser config
        range: LocalForwardProtocol
        ifabsent: "http"
      description:
        description: Brief description of what service this forward provides

  BrowserConfig:
    description: >-
      Browser-accessible URLs for facility services. After port forwards are established,
      these URLs work in a local browser. Used by agents and documentation to construct
      working URLs from wiki_sites[].name references.
    class_uri: fc:BrowserConfig
    attributes:
      services:
        description: >-
          Map of service names to localhost URLs. Keys match LocalForwardConfig.name
          and WikiSiteConfig.name. Values are full URLs including protocol and port.
        multivalued: true
        range: BrowserServiceConfig

  BrowserServiceConfig:
    description: Browser-accessible URL for a single service
    class_uri: fc:BrowserServiceConfig
    attributes:
      name:
        description: Service name (matches WikiSiteConfig.name or LocalForwardConfig.name)
        required: true
      url:
        description: >-
          Full localhost URL for browser access (e.g., "http://localhost:8880/twiki").
          Protocol derived from port forward config or explicit if no forward.
        required: true
      description:
        description: Brief description of the service
