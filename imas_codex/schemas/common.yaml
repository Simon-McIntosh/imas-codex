# Common Graph Schema
#
# This schema defines shared graph entities used across multiple domains.
# These are cross-cutting types that bridge IMAS DD and facility-specific data.
#
# Generated models: imas_codex/graph/models.py
# To regenerate: uv run build-models --force

id: https://imas.iter.org/schemas/common
name: common
title: Common Graph Schema
description: >-
  Shared graph entities used across IMAS DD and facility-specific schemas.
  These types enable cross-linking between different data domains.

license: MIT
version: 0.4.0

prefixes:
  linkml: https://w3id.org/linkml/
  common: https://imas.iter.org/schemas/common/

default_prefix: common
default_range: string

imports:
  - linkml:types
  - physics_domains

# =============================================================================
# Status Enums - Unified Lifecycle Terminology
# =============================================================================
#
# Design Philosophy:
# - Status represents lifecycle phase, not current activity
# - Progress is derived from graph relationships and properties
# - Consistent vocabulary: same words mean the same thing everywhere
#
# Common Pattern:
#   discovered -> [domain-specific completion] -> stale
#
# Where:
#   - "discovered" = entity found, in graph, awaiting processing
#   - completion term = domain-specific past tense (ingested/explored/enriched)
#   - "stale" = may need re-processing (optional)
#   - "skipped/failed/cancelled" = terminal alternatives where applicable

enums:
  IngestionStatus:
    description: >-
      Lifecycle status for MDSplus tree structure ingestion.
      Tracks whether TreeNodes have been added to the graph.
      Progress is graph-derived: compare node_count_ingested vs node_count_total.
    permissible_values:
      discovered:
        description: Tree found in facility, awaiting node ingestion
      ingested:
        description: All known nodes added to graph
      stale:
        description: Tree may have new nodes, needs re-introspection

  PathStatus:
    description: >-
      Lifecycle status for facility path discovery.
      Uses claimed_at timestamp for transient worker coordination.
      No transient states - workers claim by setting claimed_at, not by changing status.
    permissible_values:
      discovered:
        description: Path found, awaiting enumeration
      scanned:
        description: Enumerated (file_count, dir_count set), awaiting LLM score
      scored:
        description: LLM scored (may have been rescored if high-value)
      skipped:
        description: Intentionally not processed (low-score, excluded, empty)
      failed:
        description: Error during processing (check error, terminal_reason)
      stale:
        description: Path may have changed, needs re-discovery

  TerminalReason:
    description: >-
      Why resource exploration terminated. Captures reasons NOT derivable
      from other node properties (score, has_git, path_purpose). For LLM-scored
      terminal resources, leave NULL - reason is derivable from existing fields.
      Used for analytics: "show all access-denied paths", "count empty dirs".
    permissible_values:
      # === SCAN-TIME FAILURES (status=failed) ===
      access_denied:
        description: PermissionError during directory listing or page fetch
      scan_error:
        description: Other error during enumeration or link extraction
      # === NETWORK/AUTH FAILURES (wiki) ===
      fetch_error:
        description: HTTP error fetching page content
      auth_required:
        description: Page requires authentication not available
      # === DUPLICATES ===
      alias:
        description: Bind mount, symlink, or redirect to another resource
      # === AUTO-SKIP (status=skipped, 0 LLM cost) ===
      empty:
        description: Empty directory (0 files, 0 dirs) or empty page
      low_score:
        description: Interest score below threshold
      excluded:
        description: Matched exclusion pattern
      # === PROPAGATION ===
      parent_terminal:
        description: Parent resource was terminal (skipped or not expanded)
      # === LIMITS ===
      depth_limit:
        description: Maximum exploration depth reached
      budget_exhausted:
        description: Cost or page limit reached

  SourceFileStatus:
    description: >-
      Lifecycle status for source file ingestion pipeline.
      Progress is graph-derived: count CodeExample nodes linked to file.
    permissible_values:
      discovered:
        description: File found, awaiting ingestion
      ingested:
        description: Code extracted, CodeExample nodes created
      failed:
        description: Ingestion failed (check error property)
      stale:
        description: Source may have changed, needs re-fetch

  AgentRunStatus:
    description: >-
      Lifecycle status for autonomous agent runs.
      Progress is graph-derived: items_processed / items_total.
    permissible_values:
      created:
        description: Run initialized, not yet started
      running:
        description: Currently executing
      completed:
        description: Successfully finished all work
      failed:
        description: Stopped due to error
      cancelled:
        description: Stopped by user request

  EnrichmentStatus:
    description: >-
      Lifecycle status for LLM metadata enrichment of TreeNodes.
      Progress is graph-derived: check for HAS_UNIT, MAPS_TO relationships.
    permissible_values:
      discovered:
        description: Node in graph, awaiting LLM enrichment
      enriched:
        description: Successfully enriched with metadata
      stale:
        description: Needs re-enrichment (new context available)

  WikiPageStatus:
    description: >-
      Lifecycle status for wiki page discovery. Uses claimed_at timestamp for
      transient worker coordination (same pattern as FacilityPathStatus).
      
      Simple 3-phase workflow: scanned → scored → ingested
      - Bulk discovery sets status=scanned
      - Score: fetch content preview + LLM scoring in single pass
      - Ingest: embed pages with score >= 0.5
    permissible_values:
      scanned:
        description: Discovered via bulk API or crawl. Awaiting content-aware scoring.
      scored:
        description: Content-aware scoring complete. Pages with score >= 0.5 proceed to ingestion.
      ingested:
        description: Content chunked, embedded, and linked to graph
      skipped:
        description: Filtered out by scoring (too low value to process)
      failed:
        description: Error during processing (check error field)

  WikiArtifactStatus:
    description: >-
      Lifecycle status for wiki artifacts (PDFs, presentations, etc.).
      Uses claimed_at timestamp for transient worker coordination
      (same pattern as WikiPageStatus - no separate transient states).
      
      Workflow: discovered → scored → ingested (simple 3-phase)
      - Bulk discovery sets status=discovered
      - Score: download preview + LLM scoring in single pass
        Artifacts with score >= 0.5 proceed to ingestion
      - Ingest: download full content, parse, chunk, embed
    permissible_values:
      discovered:
        description: >-
          Artifact link found but not yet scored. Awaiting content-aware scoring.
      scored:
        description: >-
          Scoring complete. Score field set based on content preview.
          Artifacts with score >= 0.5 proceed to ingestion.
      ingested:
        description: Content downloaded, parsed, chunked, and embedded
      deferred:
        description: High-value but requires unsupported parser (OCR, scanned PDF, etc.)
      skipped:
        description: Filtered out by scoring (too low value to process)
      failed:
        description: Error during processing (check error field)

  FacilitySignalStatus:
    description: >-
      Lifecycle status for facility data signal discovery. Uses claimed_at timestamp
      for transient worker coordination (same pattern as WikiPageStatus).
      
      Discovery workflow: discovered → enriched → checked
      - Discover: enumerate signals from data sources (MDSplus trees, TDI functions)
      - Enrich: LLM classification of physics domain, description generation
      - Check: test data access with example_shot, verify accessor works
    permissible_values:
      discovered:
        description: Signal found via introspection (tree traversal, TDI parsing). Awaiting enrichment.
      enriched:
        description: LLM enrichment complete - physics_domain classified, description generated
      checked:
        description: Data access tested successfully - creates CHECKED_VIA link to AccessMethod
      skipped:
        description: Filtered out (duplicate, internal node, or low value)
      failed:
        description: Error during processing (check error field)

  ConventionType:
    description: >-
      Types of physics conventions documented in wiki content.
      Used for SignConvention nodes extracted from wiki.
    permissible_values:
      cocos:
        description: COCOS (Coordinate Convention for Specifying Orientations)
      sign:
        description: Sign convention for physical quantities
      direction:
        description: Directional convention (positive/negative direction)
      coordinate:
        description: Coordinate system definition
      normalization:
        description: Normalization convention

  COCOSDetermination:
    description: >-
      How a COCOS value was determined. Used for confidence assessment
      and re-validation workflows.
    permissible_values:
      metadata:
        description: From DD version, file header, or MDSplus node
      calculated:
        description: Computed from physics quantities (ψ, q, Ip, B0)
      documented:
        description: From code documentation, paper, or wiki
      asserted:
        description: User-provided, not verified

  DiscoveryTool:
    description: >-
      Workflow or tool that created graph nodes. Enables targeted removal
      and re-processing queries. Use with DiscoveryProvenance mixin.
      
      Value semantics:
      - CLI commands use underscore naming (discover_paths, clusters_build)
      - Agent tools use their registered name (scout, explore_agent)
      - Manual entry uses "manual"
    permissible_values:
      discover_paths:
        description: "CLI: imas-codex discover paths"
      discover_wiki:
        description: "CLI: imas-codex discover wiki"
      ingest_code:
        description: "CLI: imas-codex ingest run (code ingestion)"
      clusters_build:
        description: "CLI: imas-codex clusters build"
      dd_build:
        description: "CLI: imas-codex imas build"
      scout:
        description: "Agent: Scout exploration tool"
      explore_agent:
        description: "Agent: Explore subagent discoveries"
      manual:
        description: Manual entry via MCP or direct graph edit

  DiscoveryRootCategory:
    description: >-
      Broad category for discovery seeding roots. Used to ensure balanced
      discovery across simulation and experimental domains. Categories are
      intentionally general to apply across facilities (TCV, JET, ITER, etc.).
      
      The taxonomy maintains duality between:
      - Forward modeling (simulation): Predicts plasma behavior
      - Experimental analysis: Processes actual measurements
    permissible_values:
      # === FORWARD MODELING (Prediction) ===
      modeling_code:
        description: >-
          Physics simulation and modeling source code. These codes PREDICT
          plasma behavior through forward modeling.
          Examples: ASTRA, JOREK, DREAM, JINTRAC, TRANSP, CORSICA, GENE
      modeling_data:
        description: >-
          Outputs from simulation/modeling runs. Predictive results, not
          measurements. Often in HDF5, NetCDF, or custom formats.
          Examples: Parameter scans, scenario databases, turbulence outputs
      # === EXPERIMENTAL ANALYSIS (Measurement) ===
      analysis_code:
        description: >-
          Experimental data processing source code. These codes ANALYZE
          actual shot/pulse measurements through backward inference.
          Examples: Equilibrium reconstruction (LIUQE, EFIT), diagnostic
          processing (Thomson, ECE), profile fitting, real-time analysis
      experimental_data:
        description: >-
          Shot/pulse measurement data. Primary experimental records from
          actual plasma discharges, in any format (MDSplus, PPF, EDAS, etc.).
          Examples: Shot databases, diagnostic time series, processed results
      # === SHARED INFRASTRUCTURE ===
      data_access:
        description: >-
          Data access layers and common libraries. Cross-cutting tools that
          provide abstraction over raw data storage.
          Examples: MDSplus TDI functions, IDL SAL routines, IMAS wrappers,
          physics function libraries, common analysis utilities
      workflow:
        description: >-
          User analysis scripts and working environments. Active workspaces
          where researchers develop and run analysis.
          Examples: Jupyter notebooks, batch scripts, processing pipelines,
          user home directories with analysis code
      documentation:
        description: >-
          Reference materials for understanding codes and data.
          Examples: Code manuals, papers, tutorials, READMEs, wiki exports

  ResourcePurpose:
    description: >-
      LLM-classified purpose of a discoverable resource (path, page, file).
      Used during discovery scoring to determine expansion/ingestion priority.
      Score semantics vary by purpose type. Shared across discovery domains.
      
      Terminology aligns with DiscoveryRootCategory for consistent vocabulary.
    permissible_values:
      # === FORWARD MODELING CODE (predictive, offline simulation) ===
      modeling_code:
        description: Physics simulation/modeling code (CHEASE, ASTRA, JOREK, JINTRAC)
      # === EXPERIMENTAL ANALYSIS CODE (shot processing, diagnostics) ===
      analysis_code:
        description: >-
          Experimental data processing code: equilibrium reconstruction (LIUQE, EFIT),
          diagnostic analysis (Thomson, bolometry), profile fitting, intershot tools
      operations_code:
        description: >-
          Real-time facility operations: control systems, DAQ, hardware interfaces,
          timing systems, feedback algorithms, actuator commands
      # === SHARED INFRASTRUCTURE CODE ===
      data_access:
        description: Data access/conversion tools (IMAS wrappers, MDSplus readers, EQDSK, TDI)
      workflow:
        description: Orchestration and batch processing scripts
      visualization:
        description: Plotting and rendering tools
      # === DATA CATEGORIES ===
      experimental_data:
        description: Experimental shot data, measurement databases (MDSplus trees, shot archives)
      modeling_data:
        description: Outputs from modeling codes (HDF5 runs, NetCDF outputs, parameter scans)
      # === SUPPORT CATEGORIES ===
      documentation:
        description: Docs, papers, tutorials, READMEs, wiki pages
      configuration:
        description: Config files, settings, module files
      test_suite:
        description: Unit/integration tests (pytest directories)
      # === STRUCTURAL CATEGORIES ===
      container:
        description: >-
          Organizational resource with varied content (/home, /work, portal pages).
          Score reflects exploration potential of children, not content value.
          High score = explore children; low score = skip subtree.
      # === SKIP CATEGORIES (low score forced) ===
      archive:
        description: Old/backup content (backup/, old_projects/, deprecated/)
      build_artifact:
        description: Generated/cached files (__pycache__, .venv, node_modules)
      system:
        description: OS/infrastructure resources (/var, /tmp, /opt/modules)

# =============================================================================
# Classes
# =============================================================================

classes:
  LLMProvenance:
    description: >-
      Mixin providing provenance tracking for LLM-generated or LLM-enriched content.
      Use on any class where agents modify data to enable re-enrichment workflows.
      
      Enables queries like:
      - Mark all nodes enriched by model X as stale
      - Re-enrich all nodes enriched before date Y
      - Compare quality across models
    mixin: true
    class_uri: common:LLMProvenance
    attributes:
      enrichment_model:
        description: >-
          LLM model identifier used for enrichment (e.g., "google/gemini-3-pro-preview").
          Enables bulk re-enrichment when upgrading models.
      enrichment_at:
        description: >-
          ISO timestamp when LLM enrichment was performed.
          Enables time-based re-enrichment policies.
        range: datetime

  LLMOperation:
    description: >-
      Mixin for atomic LLM cost tracking on graph nodes.
      Any node that passes through an LLM (scoring, enrichment, mapping, etc.)
      can compose this mixin to track cost at the individual node level.
      For batch operations, cost is distributed as cost_per_node = batch_cost / batch_size.
      Enables cost aggregation queries with Cypher MATCH n WHERE n.llm_cost IS NOT NULL
      RETURN type, sum(n.llm_cost) AS cost ORDER BY cost DESC.
    mixin: true
    class_uri: common:LLMOperation
    attributes:
      llm_model:
        description: "Model identifier (e.g., openrouter/anthropic/claude-sonnet-4.5)"
      llm_cost:
        description: "Cost in USD for this operation (for batches: batch_cost / batch_size)"
        range: float
      llm_tokens_in:
        description: "Input tokens consumed (for batches: batch_tokens / batch_size)"
        range: integer
      llm_tokens_out:
        description: "Output tokens generated (for batches: batch_tokens / batch_size)"
        range: integer
      llm_at:
        description: When LLM operation was performed
        range: datetime

  DiscoveryProvenance:
    description: >-
      Mixin providing unified provenance tracking for all discovered/ingested nodes.
      Apply to any node type created by discovery or ingestion workflows.
      
      Enables targeted removal and re-processing queries:
      - Delete all nodes from tool X between time Y and Z
      - Re-run discovery for nodes created before schema version V
      - Track data lineage across workflows
      - Group deletions by session ID
      
      Example queries:
        MATCH (n) WHERE n.created_by_tool = 'discover_paths' 
          AND n.created_at >= datetime('2026-01-01')
          AND n.created_at < datetime('2026-01-15')
        DETACH DELETE n
        
        MATCH (n) WHERE n.created_by_session = 'session-abc123'
        DETACH DELETE n
    mixin: true
    class_uri: common:DiscoveryProvenance
    attributes:
      created_by_tool:
        description: >-
          Tool/workflow that created this node. Use DiscoveryTool enum values.
          Enables "delete everything created by discover_paths" queries.
        range: DiscoveryTool
      created_at:
        description: >-
          ISO timestamp when node was created. Required for time-based queries.
          Stored as datetime for efficient range queries.
        range: datetime
      created_by_session:
        description: >-
          Optional session/invocation ID for grouping related operations.
          Enables "delete everything from this session" queries.
          Format: ISO timestamp or UUID of CLI invocation.
      source_version:
        description: >-
          Version of imas-codex at creation time (e.g., "3.2.1").
          Enables "re-process nodes created before schema change" queries.

  COCOSMixin:
    description: >-
      Mixin providing COCOS-related attributes for entities that handle
      equilibrium data. Apply to AnalysisCode, TreeNode, or Dataset.
      
      Based on Sauter & Medvedev, CPC 184 (2013) 293-302.
      COCOS values are integers 1-8 (ψ/2π) or 11-18 (full ψ).
      
      Many codes support input/output transformation between COCOS.
      For example, CHEASE internally uses COCOS 2 but can read/write any COCOS.
    mixin: true
    class_uri: common:COCOSMixin
    attributes:
      cocos_native:
        description: >-
          Native COCOS convention used internally by this code.
          Single value (e.g., 2 for CHEASE, 17 for LIUQE).
        range: integer
      cocos_input:
        description: >-
          COCOS values this code can accept as input.
          If auto-transform is supported, may include all 16 values.
        multivalued: true
        range: integer
      cocos_output:
        description: >-
          COCOS values this code can produce as output.
          If auto-transform is supported, may include all 16 values.
        multivalued: true
        range: integer
      cocos_determination:
        description: How the COCOS value was determined
        range: COCOSDetermination
      cocos_confidence:
        description: >-
          Confidence in COCOS assignment (0.0-1.0).
          Higher when validated against physics quantities.
        range: float

  # NOTE: PhysicsDomain is now an ENUM imported from physics_domains.yaml
  # The class was removed to avoid conflict with the enum. Use the enum
  # for categorizing FacilitySignal, IMASPath, TreeNode, etc.

  Unit:
    description: >-
      A physical unit used in both IMAS Data Dictionary and facility-specific
      data. Units are deduplicated across all paths to enable unit-based queries
      and cross-linking between IMAS paths and MDSplus TreeNodes.
      
      Both IMASPath and TreeNode link to Unit via HAS_UNIT relationships,
      enabling queries like "find all paths (IMAS or facility) using Weber".
    class_uri: common:Unit
    attributes:
      symbol:
        identifier: true
        description: Unit symbol (e.g., "Wb", "m.s^-1", "eV", "A")
        required: true
      name:
        description: Human-readable name (e.g., "Weber", "meters per second")
      dimension:
        description: Physical dimension category (e.g., "magnetic_flux", "velocity")
      is_si:
        description: Whether this is an SI base or derived unit
        range: boolean

  SignConvention:
    description: >-
      A physics sign/orientation convention extracted from wiki documentation.
      Links to TreeNodes and IMASPaths that follow this convention.
      Critical for IMAS mapping correctness.
    class_uri: common:SignConvention
    attributes:
      id:
        identifier: true
        description: Unique identifier (e.g., "tcv:cocos:11", "tcv:sign:ip_positive_ccw")
        required: true
      facility_id:
        description: Facility where this convention applies
        required: true
      convention_type:
        description: Type of convention
        range: ConventionType
        required: true
      name:
        description: Short name (e.g., "COCOS 11", "Positive Ip CCW")
        required: true
      description:
        description: Full description of the convention
        required: true
      cocos_index:
        description: COCOS index number if applicable (1-18)
        range: integer
      wiki_source:
        description: URL of wiki page where this was documented
      applies_to_paths:
        description: MDSplus paths this convention applies to
        multivalued: true
      applies_to_imas:
        description: IMAS paths this convention applies to
        multivalued: true
