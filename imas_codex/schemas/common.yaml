# Common Graph Schema
#
# This schema defines shared graph entities used across multiple domains.
# These are cross-cutting types that bridge IMAS DD and facility-specific data.
#
# Generated models: imas_codex/graph/models.py
# To regenerate: uv run build-models --force

id: https://imas.iter.org/schemas/common
name: common
title: Common Graph Schema
description: >-
  Shared graph entities used across IMAS DD and facility-specific schemas.
  These types enable cross-linking between different data domains.

license: MIT
version: 0.4.0

prefixes:
  linkml: https://w3id.org/linkml/
  common: https://imas.iter.org/schemas/common/

default_prefix: common
default_range: string

imports:
  - linkml:types
  - physics_domains

# =============================================================================
# Status Enums - Unified Lifecycle Terminology
# =============================================================================
#
# Design Philosophy:
# - Status represents lifecycle phase, not current activity
# - Progress is derived from graph relationships and properties
# - Consistent vocabulary: same words mean the same thing everywhere
#
# Common Pattern:
#   discovered -> [domain-specific completion] -> stale
#
# Where:
#   - "discovered" = entity found, in graph, awaiting processing
#   - completion term = domain-specific past tense (ingested/explored/enriched)
#   - "stale" = may need re-processing (optional)
#   - "skipped/failed/cancelled" = terminal alternatives where applicable

enums:
  IngestionStatus:
    description: >-
      Lifecycle status for MDSplus tree structure ingestion.
      Tracks whether TreeNodes have been added to the graph.
      Progress is graph-derived: compare node_count_ingested vs node_count_total.
    permissible_values:
      discovered:
        description: Tree found in facility, awaiting node ingestion
      ingested:
        description: All known nodes added to graph
      stale:
        description: Tree may have new nodes, needs re-introspection

  PathStatus:
    description: >-
      Lifecycle status for facility path discovery.
      Transient states (listing, scoring, expanding) have fallback states for orphan recovery.
      Progress is graph-derived: check file_count, dir_count, interest_score.
    permissible_values:
      discovered:
        description: Path found, awaiting enumeration
      listing:
        description: Scanner worker active (fallback to discovered on timeout)
      listed:
        description: Enumerated (file_count, dir_count set), awaiting LLM score
      scoring:
        description: Scorer worker active (fallback to listed on timeout)
      scored:
        description: LLM scored (may have been rescored if high-value)
      expanding:
        description: Expander worker active (fallback to scored on timeout)
      skipped:
        description: Scan-time failure (access denied, alias, error)
      excluded:
        description: Matched exclusion pattern (not enumerated)
      stale:
        description: Path may have changed, needs re-discovery

  TerminalReason:
    description: >-
      Why path exploration terminated. Only captures reasons NOT derivable
      from other node properties (score, has_git, path_purpose). For LLM-scored
      terminal paths, leave NULL - reason is derivable from existing fields.
      Used for analytics: "show all access-denied paths", "count empty dirs".
    permissible_values:
      # === SCAN-TIME FAILURES (status=skipped, reason not in other fields) ===
      access_denied:
        description: PermissionError during directory listing
      listing_error:
        description: Other error during directory enumeration
      alias:
        description: Bind mount or symlink duplicate of another path
      # === AUTO-SKIP (status=scored, 0 LLM cost, not obvious from properties) ===
      empty:
        description: Empty directory (0 files, 0 dirs)
      # === PROPAGATION (child of terminal parent) ===
      parent_terminal:
        description: Parent path was terminal (skipped or not expanded)
      # === LIMITS ===
      depth_limit:
        description: Maximum exploration depth reached

  SourceFileStatus:
    description: >-
      Lifecycle status for source file ingestion pipeline.
      Progress is graph-derived: count CodeExample nodes linked to file.
    permissible_values:
      discovered:
        description: File found, awaiting ingestion
      ingested:
        description: Code extracted, CodeExample nodes created
      failed:
        description: Ingestion failed (check error property)
      stale:
        description: Source may have changed, needs re-fetch

  AgentRunStatus:
    description: >-
      Lifecycle status for autonomous agent runs.
      Progress is graph-derived: items_processed / items_total.
    permissible_values:
      created:
        description: Run initialized, not yet started
      running:
        description: Currently executing
      completed:
        description: Successfully finished all work
      failed:
        description: Stopped due to error
      cancelled:
        description: Stopped by user request

  EnrichmentStatus:
    description: >-
      Lifecycle status for LLM metadata enrichment of TreeNodes.
      Progress is graph-derived: check for HAS_UNIT, MAPS_TO relationships.
    permissible_values:
      discovered:
        description: Node in graph, awaiting LLM enrichment
      enriched:
        description: Successfully enriched with metadata
      stale:
        description: Needs re-enrichment (new context available)

  WikiPageStatus:
    description: >-
      Lifecycle status for wiki page discovery and ingestion.
      Three-phase process: crawl (link extraction) -> score (agent evaluation) -> ingest (content).
    permissible_values:
      crawled:
        description: Page discovered via link crawl, graph structure captured, not yet scored
      scored:
        description: Agent has evaluated and assigned interest_score, ready for ingestion if score >= threshold
      skipped:
        description: Low interest_score, agent decided not to ingest (check skip_reason)
      ingested:
        description: Full content scraped, chunked, embedded, and linked to graph
      failed:
        description: Processing failed at any phase (check error property)
      stale:
        description: Previously processed but content may have changed

  WikiArtifactStatus:
    description: >-
      Lifecycle status for wiki-linked artifacts (PDFs, presentations, etc.).
      Same phases as pages: crawl -> score -> ingest (PDF only, others deferred).
    permissible_values:
      crawled:
        description: Artifact found during crawl, awaiting scoring
      scored:
        description: Agent has evaluated filename/context and assigned interest_score
      ingested:
        description: Content extracted, chunked, and embedded (PDF only)
      deferred:
        description: High-value but requires unsupported parser (OCR, etc.)
      skipped:
        description: Low-value artifact, not worth processing
      failed:
        description: Processing failed (check error property)

  ConventionType:
    description: >-
      Types of physics conventions documented in wiki content.
      Used for SignConvention nodes extracted from wiki.
    permissible_values:
      cocos:
        description: COCOS (Coordinate Convention for Specifying Orientations)
      sign:
        description: Sign convention for physical quantities
      direction:
        description: Directional convention (positive/negative direction)
      coordinate:
        description: Coordinate system definition
      normalization:
        description: Normalization convention

  COCOSDetermination:
    description: >-
      How a COCOS value was determined. Used for confidence assessment
      and re-validation workflows.
    permissible_values:
      metadata:
        description: From DD version, file header, or MDSplus node
      calculated:
        description: Computed from physics quantities (ψ, q, Ip, B0)
      documented:
        description: From code documentation, paper, or wiki
      asserted:
        description: User-provided, not verified

  DiscoveryRootCategory:
    description: >-
      Broad category for discovery seeding roots. Used to ensure balanced
      discovery across simulation and experimental domains. Categories are
      intentionally general to apply across facilities (TCV, JET, ITER, etc.).
      
      The taxonomy maintains duality between:
      - Forward modeling (simulation): Predicts plasma behavior
      - Experimental analysis: Processes actual measurements
    permissible_values:
      # === FORWARD MODELING (Prediction) ===
      modeling_code:
        description: >-
          Physics simulation and modeling source code. These codes PREDICT
          plasma behavior through forward modeling.
          Examples: ASTRA, JOREK, DREAM, JINTRAC, TRANSP, CORSICA, GENE
      modeling_data:
        description: >-
          Outputs from simulation/modeling runs. Predictive results, not
          measurements. Often in HDF5, NetCDF, or custom formats.
          Examples: Parameter scans, scenario databases, turbulence outputs
      # === EXPERIMENTAL ANALYSIS (Measurement) ===
      analysis_code:
        description: >-
          Experimental data processing source code. These codes ANALYZE
          actual shot/pulse measurements through backward inference.
          Examples: Equilibrium reconstruction (LIUQE, EFIT), diagnostic
          processing (Thomson, ECE), profile fitting, real-time analysis
      experimental_data:
        description: >-
          Shot/pulse measurement data. Primary experimental records from
          actual plasma discharges, in any format (MDSplus, PPF, EDAS, etc.).
          Examples: Shot databases, diagnostic time series, processed results
      # === SHARED INFRASTRUCTURE ===
      data_access:
        description: >-
          Data access layers and common libraries. Cross-cutting tools that
          provide abstraction over raw data storage.
          Examples: MDSplus TDI functions, IDL SAL routines, IMAS wrappers,
          physics function libraries, common analysis utilities
      workflow:
        description: >-
          User analysis scripts and working environments. Active workspaces
          where researchers develop and run analysis.
          Examples: Jupyter notebooks, batch scripts, processing pipelines,
          user home directories with analysis code
      documentation:
        description: >-
          Reference materials for understanding codes and data.
          Examples: Code manuals, papers, tutorials, READMEs, wiki exports

# =============================================================================
# Classes
# =============================================================================

classes:
  LLMProvenance:
    description: >-
      Mixin providing provenance tracking for LLM-generated or LLM-enriched content.
      Use on any class where agents modify data to enable re-enrichment workflows.
      
      Enables queries like:
      - Mark all nodes enriched by model X as stale
      - Re-enrich all nodes enriched before date Y
      - Compare quality across models
    mixin: true
    class_uri: common:LLMProvenance
    attributes:
      enrichment_model:
        description: >-
          LLM model identifier used for enrichment (e.g., "google/gemini-3-pro-preview").
          Enables bulk re-enrichment when upgrading models.
      enrichment_at:
        description: >-
          ISO timestamp when LLM enrichment was performed.
          Enables time-based re-enrichment policies.
        range: datetime

  LLMOperation:
    description: >-
      Mixin for atomic LLM cost tracking on graph nodes.
      Any node that passes through an LLM (scoring, enrichment, mapping, etc.)
      can compose this mixin to track cost at the individual node level.
      For batch operations, cost is distributed as cost_per_node = batch_cost / batch_size.
      Enables cost aggregation queries with Cypher MATCH n WHERE n.llm_cost IS NOT NULL
      RETURN type, sum(n.llm_cost) AS cost ORDER BY cost DESC.
    mixin: true
    class_uri: common:LLMOperation
    attributes:
      llm_model:
        description: "Model identifier (e.g., openrouter/anthropic/claude-sonnet-4.5)"
      llm_cost:
        description: "Cost in USD for this operation (for batches: batch_cost / batch_size)"
        range: float
      llm_tokens_in:
        description: "Input tokens consumed (for batches: batch_tokens / batch_size)"
        range: integer
      llm_tokens_out:
        description: "Output tokens generated (for batches: batch_tokens / batch_size)"
        range: integer
      llm_at:
        description: When LLM operation was performed
        range: datetime

  COCOSMixin:
    description: >-
      Mixin providing COCOS-related attributes for entities that handle
      equilibrium data. Apply to AnalysisCode, TreeNode, or Dataset.
      
      Based on Sauter & Medvedev, CPC 184 (2013) 293-302.
      COCOS values are integers 1-8 (ψ/2π) or 11-18 (full ψ).
      
      Many codes support input/output transformation between COCOS.
      For example, CHEASE internally uses COCOS 2 but can read/write any COCOS.
    mixin: true
    class_uri: common:COCOSMixin
    attributes:
      cocos_native:
        description: >-
          Native COCOS convention used internally by this code.
          Single value (e.g., 2 for CHEASE, 17 for LIUQE).
        range: integer
      cocos_input:
        description: >-
          COCOS values this code can accept as input.
          If auto-transform is supported, may include all 16 values.
        multivalued: true
        range: integer
      cocos_output:
        description: >-
          COCOS values this code can produce as output.
          If auto-transform is supported, may include all 16 values.
        multivalued: true
        range: integer
      cocos_determination:
        description: How the COCOS value was determined
        range: COCOSDetermination
      cocos_confidence:
        description: >-
          Confidence in COCOS assignment (0.0-1.0).
          Higher when validated against physics quantities.
        range: float

  # NOTE: PhysicsDomain is now an ENUM imported from physics_domains.yaml
  # The class was removed to avoid conflict with the enum. Use the enum
  # for categorizing FacilitySignal, IMASPath, TreeNode, etc.

  Unit:
    description: >-
      A physical unit used in both IMAS Data Dictionary and facility-specific
      data. Units are deduplicated across all paths to enable unit-based queries
      and cross-linking between IMAS paths and MDSplus TreeNodes.
      
      Both IMASPath and TreeNode link to Unit via HAS_UNIT relationships,
      enabling queries like "find all paths (IMAS or facility) using Weber".
    class_uri: common:Unit
    attributes:
      symbol:
        identifier: true
        description: Unit symbol (e.g., "Wb", "m.s^-1", "eV", "A")
        required: true
      name:
        description: Human-readable name (e.g., "Weber", "meters per second")
      dimension:
        description: Physical dimension category (e.g., "magnetic_flux", "velocity")
      is_si:
        description: Whether this is an SI base or derived unit
        range: boolean

  SignConvention:
    description: >-
      A physics sign/orientation convention extracted from wiki documentation.
      Links to TreeNodes and IMASPaths that follow this convention.
      Critical for IMAS mapping correctness.
    class_uri: common:SignConvention
    attributes:
      id:
        identifier: true
        description: Unique identifier (e.g., "tcv:cocos:11", "tcv:sign:ip_positive_ccw")
        required: true
      facility_id:
        description: Facility where this convention applies
        required: true
      convention_type:
        description: Type of convention
        range: ConventionType
        required: true
      name:
        description: Short name (e.g., "COCOS 11", "Positive Ip CCW")
        required: true
      description:
        description: Full description of the convention
        required: true
      cocos_index:
        description: COCOS index number if applicable (1-18)
        range: integer
      wiki_source:
        description: URL of wiki page where this was documented
      applies_to_paths:
        description: MDSplus paths this convention applies to
        multivalued: true
      applies_to_imas:
        description: IMAS paths this convention applies to
        multivalued: true
