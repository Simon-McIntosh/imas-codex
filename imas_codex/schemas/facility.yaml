# Fusion Facility Schema (Unified)
#
# This schema defines ALL facility data - both public (graphed) and private.
# Fields marked with `is_private: true` are:
#   - Stored in <facility>_private.yaml (gitignored)
#   - NEVER written to the Neo4j graph
#   - NEVER included in OCI artifact pushes
#
# Public fields are stored in <facility>.yaml and the graph.
#
# Generated models: imas_codex/graph/models.py
# To regenerate: uv run build-models --force
#
# VERSIONING: The version field below is kept in sync with the project version.
# The release workflow updates both together. Do not manually edit the version.

id: https://imas.iter.org/schemas/facility
name: facility
title: Fusion Facility Schema (Unified)
description: >-
  Unified schema for fusion research facilities. Fields with is_private: true
  are stored locally only (gitignored YAML), never in the public graph.

license: MIT
version: 0.4.0

prefixes:
  linkml: https://w3id.org/linkml/
  facility: https://imas.iter.org/schemas/facility/
  imas: https://imas.iter.org/
  schema: https://schema.org/

default_prefix: facility
default_range: string

imports:
  - linkml:types
  - common
  - imas_dd

# =============================================================================
# Enums
# =============================================================================

enums:
  DataSourceType:
    description: Types of data source systems at fusion facilities
    permissible_values:
      mdsplus:
        description: MDSplus tree-based data system
      tdi:
        description: TDI function-based data access layer
      uda:
        description: Universal Data Access (UDA) system
      hdf5:
        description: HDF5 file-based storage
      netcdf:
        description: NetCDF scientific data format
      imas:
        description: IMAS native data format
      ppf:
        description: JET Processed Pulse File system
      allas:
        description: CSC Allas object storage

  ToolStatus:
    description: Availability status of a command-line tool
    permissible_values:
      available:
        description: Tool is installed and accessible
      unavailable:
        description: Tool is not installed
      restricted:
        description: Tool exists but requires special access

  TreeNodeType:
    description: MDSplus node data types
    permissible_values:
      STRUCTURE:
        description: Container node with no data
      SIGNAL:
        description: Time-varying measurement data
      NUMERIC:
        description: Numeric scalar or array
      TEXT:
        description: Text/string data
      AXIS:
        description: Coordinate axis data
      SUBTREE:
        description: Reference to another tree
      ACTION:
        description: Action sequence node
      DISPATCH:
        description: Dispatch scheduling node
      TASK:
        description: Task definition node

  DiagnosticCategory:
    description: Categories of fusion plasma diagnostics
    permissible_values:
      magnetics:
        description: Magnetic field and flux measurements
      spectroscopy:
        description: Spectroscopic diagnostics (visible, UV, X-ray)
      particle:
        description: Particle diagnostics (CX, NPA, beam emission)
      imaging:
        description: Camera and imaging systems
      microwave:
        description: Microwave diagnostics (ECE, reflectometry)
      bolometry:
        description: Radiated power measurements
      neutron:
        description: Neutron flux and spectrum diagnostics
      probe:
        description: Langmuir probes and other insertable probes
      interferometry:
        description: Interferometric density measurements
      thomson:
        description: Thomson scattering systems

  AnalysisCodeType:
    description: Types of physics analysis codes
    permissible_values:
      equilibrium:
        description: Equilibrium reconstruction (EFIT, LIUQE, CLISTE)
      transport:
        description: Transport analysis (ASTRA, TRANSP, JETTO)
      mhd:
        description: MHD stability analysis
      heating:
        description: Heating deposition codes (TORAY, TORBEAM, NUBEAM)
      control:
        description: Real-time plasma control systems
      profile_fitting:
        description: Profile fitting and kinetic analysis
      integrated:
        description: Integrated modeling workflows

  ServerRole:
    description: Role of a data server in the facility infrastructure
    permissible_values:
      primary:
        description: Main production data server
      secondary:
        description: Backup or read-replica server
      legacy:
        description: Historical/archived data server
      realtime:
        description: Real-time control system data
      analysis:
        description: Analysis results server

  DataFormatType:
    description: Types of data storage formats
    permissible_values:
      mdsplus:
        description: MDSplus tree-based storage
      hdf5:
        description: HDF5 hierarchical data format
      netcdf:
        description: NetCDF scientific data format
      csv:
        description: Comma-separated values
      json:
        description: JSON data files
      mat:
        description: MATLAB .mat files
      idl:
        description: IDL save files
      imas:
        description: IMAS data format

  # Note: IngestionStatus, PathStatus, SourceFileStatus, AgentRunStatus,
  # EnrichmentStatus are defined in common.yaml with unified terminology.
  # See common.yaml for the design philosophy and value definitions.

  PopulationType:
    description: How tree nodes are populated with data
    permissible_values:
      static:
        description: Structure is fixed, always present
      dynamic:
        description: Nodes created at runtime by analysis codes
      hybrid:
        description: Mix of static structure with dynamic population

  ProgrammingLanguage:
    description: Programming languages for code examples
    permissible_values:
      python:
        description: Python source code
      matlab:
        description: MATLAB/Octave code
      fortran:
        description: Fortran source code
      idl:
        description: IDL (Interactive Data Language)
      tdi:
        description: TDI (Tree Data Interface) expressions
      cpp:
        description: C++ source code
      julia:
        description: Julia source code

  PathType:
    description: Types of filesystem paths at a facility
    permissible_values:
      code_directory:
        description: Directory containing analysis codes or scripts
      data_directory:
        description: Directory containing data files
      config_directory:
        description: Directory containing configuration files
      binary_directory:
        description: Directory containing executables

  PathPurpose:
    description: >-
      LLM-classified purpose of a directory. Used during discovery scoring
      to determine expansion priority (for containers) or ingestion priority
      (for leaf directories). Score semantics vary by purpose type.
      
      Terminology aligns with DiscoveryRootCategory for consistent vocabulary.
    permissible_values:
      # === FORWARD MODELING CODE (predictive, offline simulation) ===
      modeling_code:
        description: Physics simulation/modeling code (CHEASE, ASTRA, JOREK, JINTRAC)
      # === EXPERIMENTAL ANALYSIS CODE (shot processing, diagnostics) ===
      analysis_code:
        description: >-
          Experimental data processing code: equilibrium reconstruction (LIUQE, EFIT),
          diagnostic analysis (Thomson, bolometry), profile fitting, intershot tools
      operations_code:
        description: >-
          Real-time facility operations: control systems, DAQ, hardware interfaces,
          timing systems, feedback algorithms, actuator commands
      # === SHARED INFRASTRUCTURE CODE ===
      data_access:
        description: Data access/conversion tools (IMAS wrappers, MDSplus readers, EQDSK, TDI)
      workflow:
        description: Orchestration and batch processing scripts
      visualization:
        description: Plotting and rendering tools
      # === DATA CATEGORIES ===
      experimental_data:
        description: Experimental shot data, measurement databases (MDSplus trees, shot archives)
      modeling_data:
        description: Outputs from modeling codes (HDF5 runs, NetCDF outputs, parameter scans)
      # === SUPPORT CATEGORIES ===
      documentation:
        description: Docs, papers, tutorials, READMEs
      configuration:
        description: Config files, settings, module files
      test_suite:
        description: Unit/integration tests (pytest directories)
      # === STRUCTURAL CATEGORIES ===
      container:
        description: >-
          Organizational directory with varied content (/home, /work, /work/imas).
          Score reflects exploration potential of children, not content value.
          High score = explore children; low score = skip subtree.
      # === SKIP CATEGORIES (low score forced) ===
      archive:
        description: Old/backup content (backup/, old_projects/, deprecated/)
      build_artifact:
        description: Generated/cached files (__pycache__, .venv, node_modules)
      system:
        description: OS/infrastructure directories (/var, /tmp, /opt/modules)

  DiscoveryStatus:
    description: >-
      Lifecycle status for graph-led discovery pipeline.
      Simplified from PathStatus for scan/score workflow.
    permissible_values:
      pending:
        description: Path awaiting scan (newly seeded or from expansion)
      scanned:
        description: Directory enumerated, DirStats collected
      scored:
        description: LLM has evaluated and scored
      skipped:
        description: Excluded (dead-end, error, or low value)

  DataReferenceType:
    description: Type of data reference found in source code
    permissible_values:
      mdsplus_path:
        description: Direct MDSplus tree path (e.g., \\RESULTS::PSI)
      tdi_call:
        description: TDI function call (e.g., tcv_eq("PSI", "LIUQE"))
      imas_path:
        description: IMAS data dictionary path (future)

  TreeNodeSource:
    description: How a TreeNode was discovered and ingested
    permissible_values:
      tree_introspection:
        description: >-
          Discovered via MDSplus tree introspection (getNodeWild).
          Path is the physical tree path. Has node_type.
      code_extraction:
        description: >-
          Extracted from source code via code_examples pipeline.
          Path may be abbreviated (no full hierarchy).
          May represent accessor-level path, not physical node.
      tdi_parameter:
        description: >-
          A parameter accepted by a TDI function (e.g., tcv_eq("PSI")).
          Not a physical tree path but a logical data accessor name.
          Links to TreeNode via accessor_function relationship.
      manual:
        description: Manually created during exploration or testing

  ArtifactType:
    description: Types of wiki-linked artifacts (non-HTML files)
    permissible_values:
      pdf:
        description: PDF document (manuals, papers, reports)
      presentation:
        description: PowerPoint/Keynote slides (.ppt, .pptx, .key)
      document:
        description: Word/text documents (.doc, .docx, .odt, .rtf)
      spreadsheet:
        description: Spreadsheet files (.xls, .xlsx, .csv)
      image:
        description: Image files (.png, .jpg, .gif, .svg)
      notebook:
        description: Computational notebooks (.nb, .ipynb)
      json:
        description: JSON data files (.json)
      data:
        description: Data files (.mat, .hdf5, .nc)
      archive:
        description: Archive files (.zip, .tar, .gz)
      other:
        description: Other file types

  DocSourceType:
    description: Types of documentation sources for discovery
    permissible_values:
      mediawiki:
        description: MediaWiki-based sites (Wikipedia, SPCwiki)
      confluence:
        description: Atlassian Confluence (REST API available)
      readthedocs:
        description: ReadTheDocs hosted documentation
      github_wiki:
        description: GitHub wiki pages
      sphinx:
        description: Sphinx-generated documentation
      generic_html:
        description: Generic HTML site (scrape only)

  DocSourceStatus:
    description: Status of a documentation source
    permissible_values:
      active:
        description: Source is enabled for discovery
      paused:
        description: Temporarily disabled (e.g., auth issues)
      disabled:
        description: Permanently disabled

  FileCategory:
    description: Category of a discovered file
    permissible_values:
      code:
        description: Source code file (Python, Fortran, etc.)
      document:
        description: Document file (PDF, Word, README, etc.)
      data:
        description: Data file (HDF5, NetCDF, CSV, etc.)
      config:
        description: Configuration file (YAML, JSON, INI, etc.)
      notebook:
        description: Computational notebook (Jupyter, Mathematica)
      other:
        description: Other file types

  # Legacy alias - will be removed in future version
  WikiSiteType:
    description: "[DEPRECATED] Use DocSourceType instead"
    permissible_values:
      mediawiki:
        description: MediaWiki-based sites (Wikipedia, SPCwiki)
      confluence:
        description: Atlassian Confluence (REST API available)
      generic:
        description: Generic HTML site (scrape only)

  WikiAuthType:
    description: Authentication methods for wiki sites
    permissible_values:
      none:
        description: No authentication required
      ssh_proxy:
        description: Access via SSH tunnel (internal network only)
      basic:
        description: HTTP Basic authentication (username/password)
      session:
        description: Session-based auth (login form, cookies)

  WikiPageStatus:
    description: >-
      Lifecycle status for wiki page discovery. Uses claimed_at timestamp for
      transient worker coordination (same pattern as FacilityPathStatus).
      
      Workflow: scanned → scored → ingested (simple 3-phase)
      - Bulk discovery sets status=scanned
      - Score: fetch content preview + LLM scoring in single pass
        Pages with score >= 0.5 proceed to ingestion
      - Ingest: embed pages with score >= 0.5
    permissible_values:
      scanned:
        description: >-
          Discovered via bulk API or crawl. Awaiting content-aware scoring.
      scored:
        description: >-
          Content-aware scoring complete. Score field set based on page content.
          Pages with score >= 0.5 proceed to ingestion.
      ingested:
        description: Content chunked, embedded, and linked to graph
      skipped:
        description: Filtered out by scoring (too low value to process)
      failed:
        description: Error during processing (check error field)

  WikiArtifactStatus:
    description: >-
      Lifecycle status for wiki artifacts (PDFs, presentations, etc.).
      Uses claimed_at timestamp for transient worker coordination
      (same pattern as WikiPageStatus - no separate transient states).
      
      Workflow: discovered → scored → ingested (simple 3-phase)
      - Bulk discovery sets status=discovered
      - Score: download preview + LLM scoring in single pass
        Artifacts with score >= 0.5 proceed to ingestion
      - Ingest: download full content, parse, chunk, embed
      
      Score-exempt artifacts (score_exempt=true, e.g. images) skip the
      scored phase entirely: discovered → ingested. They are picked up
      directly by the ingestion worker without LLM text scoring.
    permissible_values:
      discovered:
        description: >-
          Artifact link found but not yet scored. Awaiting content-aware scoring.
          Score-exempt artifacts (images) are picked up directly from this
          state by the ingestion worker.
      scored:
        description: >-
          Scoring complete. Score field set based on content preview.
          Artifacts with score >= 0.5 proceed to ingestion.
      ingested:
        description: Content downloaded, parsed, chunked, and embedded
      deferred:
        description: High-value but requires unsupported parser (OCR, scanned PDF, etc.)
      skipped:
        description: Filtered out by scoring (too low value to process)
      failed:
        description: Error during processing (check error field)

  ImageStatus:
    description: >-
      Lifecycle for image processing. Images are discovered during page
      ingestion, downloaded and stored as downsampled bytes, then scored
      and captioned by a VLM in a single pass.
      
      Workflow: discovered → ingested → captioned
      - discovered: Image reference found during parent ingestion
      - ingested: Downloaded, downsampled to WebP 768px, bytes stored in graph
      - captioned: VLM caption + score generated (single pass)
      - failed: Error during processing (retryable)
    permissible_values:
      discovered:
        description: Image reference found during parent resource ingestion
      ingested:
        description: Downloaded, downsampled, and stored as bytes in graph
      captioned:
        description: VLM caption and score generated
      failed:
        description: Error during processing (check error field). Reset to ingested for retry.

  ImageSourceType:
    description: >-
      How an image was discovered. Determines fetch strategy and
      the type of parent node it links from.
    permissible_values:
      wiki_inline:
        description: Inline image tag in wiki page HTML
      wiki_file:
        description: Standalone image file from wiki (allimages API, pub_path)
      document_figure:
        description: Figure extracted from PDF, PPTX, or DOCX during artifact ingestion
      code_output:
        description: Plot or diagram generated by analysis code
      diagnostic:
        description: Diagnostic schematic or result image

  RepoSourceType:
    description: Source hosting type for software repositories
    permissible_values:
      github:
        description: GitHub-hosted repository
      gitlab:
        description: GitLab-hosted repository (public or self-hosted)
      bitbucket:
        description: Bitbucket-hosted repository
      svn:
        description: Subversion repository
      local:
        description: Local repository without public remote

# =============================================================================
# Core Classes
# =============================================================================

classes:
  Facility:
    description: >-
      A fusion research facility. Root node for facility-specific knowledge.
      Public fields are stored in the graph. Private fields (is_private: true)
      are stored in <facility>_private.yaml only.
    class_uri: facility:Facility
    attributes:
      # === PUBLIC FIELDS (graph + tcv.yaml) ===
      id:
        identifier: true
        description: Unique facility identifier (e.g., "tcv", "iter", "jet")
        required: true
      name:
        description: Human-readable facility name (e.g., "EPFL/TCV")
        required: true
      description:
        description: Facility description
      machine:
        description: Tokamak/stellarator name (e.g., "TCV", "ITER", "JET")
      location:
        description: Geographic location
      data_systems:
        description: Data systems available (e.g., "mdsplus", "uda")
        multivalued: true

      # === PRIVATE FIELDS (<facility>_private.yaml only, never graphed) ===
      ssh_host:
        description: SSH host alias for connection
        annotations:
          is_private: true
      hostnames:
        description: Network hostnames for this facility
        multivalued: true
        annotations:
          is_private: true
      nfs_mounts:
        description: NFS mount points (JSON-encoded list)
        multivalued: true
        annotations:
          is_private: true
      paths:
        description: Key filesystem paths (JSON-encoded dict)
        annotations:
          is_private: true
      excludes:
        description: Paths/patterns to exclude during exploration (JSON-encoded)
        annotations:
          is_private: true
      tools:
        description: Tool availability map (JSON-encoded dict)
        annotations:
          is_private: true
      os_info:
        description: Operating system details (JSON-encoded)
        annotations:
          is_private: true
      python_info:
        description: Python environment details (JSON-encoded)
        annotations:
          is_private: true
      compilers:
        description: Compiler availability (JSON-encoded)
        annotations:
          is_private: true
      containers:
        description: Available container images (JSON-encoded)
        annotations:
          is_private: true
      exploration_notes:
        description: Free-form exploration notes
        multivalued: true
        annotations:
          is_private: true
      wiki_sites:
        description: >-
          Wiki/documentation sites for this facility (JSON-encoded list).
          Each site: {url, portal_page, site_type, auth_type, credential_service}.
          credential_service is the keyring service name for credentials.
        annotations:
          is_private: true
      discovery_roots:
        description: >-
          Explicit seeding paths for discovery pipeline (JSON-encoded list).
          Each root: {path, category, priority, description}.
          Overrides automatic path extraction from paths: structure.
        annotations:
          is_private: true
      data_sources:
        description: >-
          Data source configuration for signal discovery.
          Structure:
            mdsplus:
              trees: [name, ...]  # MDSplus tree names to scan
              tdi_paths: [path, ...]  # TDI function directories
              reference_shot: int  # Shot for tree introspection
            hdf5:
              paths: [path, ...]  # HDF5 file/directory paths
            imas:
              backends: [mdsplus, hdf5, ...]  # Available backends
          Used by: imas-codex discover data <facility>

  DiscoveryRoot:
    description: >-
      A configured root path for seeding the discovery frontier.
      Stored in facility_private.yaml under discovery_roots.
      
      Use category to ensure balanced discovery across:
      - Simulation: modeling codes and their outputs
      - Experimental: shot archives, diagnostics, reconstructions
      - Cross-cutting: TDI functions, analysis workflows, docs
      
      Higher priority roots are processed first during seeding.
    class_uri: facility:DiscoveryRoot
    attributes:
      path:
        identifier: true
        description: Absolute filesystem path to seed
        required: true
      category:
        description: Discovery root category for balanced seeding
        range: DiscoveryRootCategory
        required: true
      priority:
        description: >-
          Seeding priority (higher = seed first). Default 1.
          Use to front-load high-value areas.
        range: integer
      description:
        description: Brief description of what this root contains

  FacilityPath:
    description: >-
      A filesystem path at a remote facility for structured exploration.
      
      REQUIRED TOOLS (install at ~/bin before exploration):
      - rg (ripgrep): Fast pattern search with --max-depth, --max-count limits
      - fd: Fast file finder, safer than find for large directories
      - tokei: Lines of code by language (parallel, very fast)
      - eza: Tree view for directory hierarchy context
      
      PARALLEL DISCOVERY PIPELINE:
      1. Scan: discovered -> listing -> listed (enumerate files, set counts)
      2. Score: listed -> scoring -> scored (LLM evaluates, sets score/expand/enrich)
      3. Expand: scored + should_expand -> children created as discovered
      4. Enrich: scored + should_enrich -> enriched (du/tokei/patterns)
      5. Rescore: enriched -> rescored (optional refinement with enrichment data)
      
      Expand and Enrich run in PARALLEL as independent workers.
      Rescore runs after enrichment for high-value paths.
      
      Terminal states:
      - scored: Has LLM score, ready for ingestion if high-value
      - skipped: Low score (< 0.2), not worth ingesting
      - excluded: Matched exclusion pattern (never scanned)
      - stale: May have changed, needs re-discovery
      
      Query paths by status to find work for each phase.
      Use score field to prioritize paths for code ingestion.
    mixins:
      - LLMOperation
      - DiscoveryProvenance
    class_uri: facility:FacilityPath
    attributes:
      id:
        identifier: true
        description: Composite key as facility:path (e.g., "tcv:/home/codes")
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      path:
        description: Absolute filesystem path
        required: true
      realpath:
        description: >-
          Resolved real path after symlink resolution (via os.path.realpath).
          Used for deduplication when same directory is accessible via multiple
          paths (e.g., /mnt/HPC/home/user vs /home/user pointing to same location).
          Null if path is not a symlink and hasn't been resolved.
      is_symlink:
        description: >-
          True if this path entry is a symlink to another location.
          Symlink directories are discovered but not expanded to avoid
          scanning the same content multiple times.
        range: boolean
      device_inode:
        description: >-
          Filesystem device:inode identifier (e.g., "64:9468985").
          PRIMARY deduplication key for detecting paths that resolve to the
          same physical directory, including bind mounts that os.path.realpath
          cannot detect. Paths with matching device_inode are aliases.
      alias_of_id:
        description: >-
          Link to the canonical FacilityPath that this symlink resolves to.
          Only set when is_symlink=true. Enables queries like:
          MATCH (alias)-[:ALIAS_OF]->(real) WHERE alias.path = $search_path
          RETURN real  -- gets the actual content node
        range: FacilityPath
      canonicality:
        description: >-
          Path preference score (higher = more canonical). Used to decide which
          of multiple bind-mount paths is canonical vs alias. /home = 100,
          /work = 80, /mnt = 10. Ensures user-facing paths like /home are
          preferred over infrastructure paths like /mnt/HPC/home.
        range: integer
      path_type:
        description: Type of path
        range: PathType
        required: true
      status:
        description: Exploration status
        range: PathStatus
        required: true
      in_directory:
        description: Parent directory containing this path (null for root paths)
        range: FacilityPath
      depth:
        description: Distance from root path (0 = root like /home/codes)
        range: integer
      description:
        description: Human-readable description of what this path contains
      embedding:
        description: Vector embedding of description for semantic search
        multivalued: true
        range: float
      discovered_at:
        description: When this path was first discovered
        range: datetime
      last_examined:
        description: When this path was last examined by any pass
        range: datetime
      # Coverage tracking
      file_count:
        description: Total files in directory (set during listing)
        range: integer
      dir_count:
        description: Total subdirectories (set during listing)
        range: integer
      files_scanned:
        description: Files that matched patterns during scanning
        range: integer
      files_ingested:
        description: Files extracted to CodeExample nodes
        range: integer
      # Scout guidance
      patterns_found:
        description: Patterns that matched during scanning (e.g., "equilibrium", "IMAS")
        multivalued: true
      notes:
        description: Free-form notes about this path (append, don't overwrite)
      # Scoring dimensions (LLM-assigned, 0.0-1.0 each)
      # Per-purpose scores aligned with DiscoveryRootCategory taxonomy
      # Enables downstream actors to query specific dimensions
      score:
        description: Composite interest score (0.0-1.0), max of per-purpose scores
        range: float
      score_percentile:
        description: Percentile rank within facility (0.0-1.0), updated periodically
        range: float
      # Code dimensions
      score_modeling_code:
        description: Score for forward modeling/simulation code (CHEASE, ASTRA, JOREK)
        range: float
      score_analysis_code:
        description: Score for experimental analysis code (diagnostic processing, LIUQE)
        range: float
      score_operations_code:
        description: Score for real-time operations code (control systems, DAQ)
        range: float
      # Data dimensions
      score_modeling_data:
        description: Score for modeling outputs (HDF5 runs, parameter scans)
        range: float
      score_experimental_data:
        description: Score for experimental shot data (MDSplus trees, pulse files)
        range: float
      # Infrastructure dimensions
      score_data_access:
        description: Score for data access tools (IMAS wrappers, MDSplus readers)
        range: float
      score_workflow:
        description: Score for orchestration and batch processing
        range: float
      score_visualization:
        description: Score for plotting and rendering tools
        range: float
      # Support dimensions
      score_documentation:
        description: Score for documentation value (READMEs, tutorials, papers)
        range: float
      # Cross-cutting
      score_imas:
        description: Score for IMAS relevance (IDS patterns, put_slice, etc.)
        range: float
      is_multiformat:
        description: True if code loads one format and writes another (indicates mapping utility)
        range: boolean
      evidence_id:
        description: Link to Evidence node with semantic indicators
        range: Evidence
      should_expand:
        description: Whether to explore child directories
        range: boolean
      expansion_reason:
        description: Why this directory should be expanded
      should_enrich:
        description: >-
          Whether to run deep analysis (du, tokei, patterns) on this path.
          Decided by LLM during scoring based on path depth, size estimate,
          and purpose. False for huge dirs like /work, /home that would hang.
        range: boolean
      enrich_skip_reason:
        description: Why enrichment was skipped (e.g., "too large", "no code files")
      keywords:
        description: Searchable keywords for this directory
        multivalued: true
      physics_domain:
        description: Primary physics domain (equilibrium, transport, etc.)
      path_purpose:
        description: Classified purpose of the directory
        range: PathPurpose
      # Enrichment tracking (for high-value paths with du/tokei data)
      is_enriched:
        description: Whether this path has been enriched with deep scan data
        range: boolean
      enriched_at:
        description: When enrichment was completed
        range: datetime
      total_bytes:
        description: Total size in bytes (from du -sb)
        range: integer
      total_lines:
        description: Total lines of code (from tokei/scc)
        range: integer
      language_breakdown:
        description: JSON-encoded language breakdown from tokei/scc
      # Scout session tracking
      skip_reason:
        description: >-
          Free-text details for terminal_reason. Contains extra context like
          "Alias of /path/to/canonical" or specific error messages.
          For filtering, use terminal_reason enum instead.
      terminal_reason:
        description: >-
          Why this path terminated exploration. Required when terminal
          (status=skipped OR should_expand=false). Enables filtering by
          termination cause: access_denied vs low_value vs software_repo.
        range: TerminalReason
      skipped_at:
        description: When this path was marked as skipped
        range: datetime
      scored_at:
        description: When this path was scored
        range: datetime
      rescored_at:
        description: When this path was rescored with enrichment data (null if not rescored)
        range: datetime
      session_id:
        description: Scout session that discovered/processed this path
      # Git repository detection (set during scan if .git exists)
      has_git:
        description: Whether this directory contains a .git folder
        range: boolean
      git_remote_url:
        description: Git remote origin URL if available
      git_head_commit:
        description: HEAD commit hash at time of discovery
      git_branch:
        description: Current git branch name
      git_root_commit:
        description: >-
          First commit hash in repository history (root/birth commit).
          Used to identify forks/clones even without remote URL.
          Computed via: git rev-list --max-parents=0 HEAD
      software_repo_id:
        description: Link to SoftwareRepo node if this is a git clone
        range: SoftwareRepo
      # Scan statistics (set during listing)
      total_files:
        description: Total files in directory (set during listing)
        range: integer
      total_dirs:
        description: Total subdirectories (set during listing)
        range: integer
      file_type_counts:
        description: JSON-encoded file type counts from scan
      child_names:
        description: JSON-encoded list of child file/dir names for LLM context
      tree_context:
        description: >-
          Tree output showing 2-level directory hierarchy (eza --tree --level 2).
          Provides better context than flat child_names for complex directories.
          Capped at 25 lines to limit tokens.
      numeric_dir_ratio:
        description: >-
          Fraction of subdirectories with numeric names (0.0-1.0).
          High ratio (>0.5) indicates data container (shot IDs, run numbers).
          Used to prevent wasteful expansion into data directories.
        range: float
      listed_at:
        description: When this path completed listing
        range: datetime
      # Expansion tracking
      expanded_at:
        description: When children were created for this path (null if not expanded)
        range: datetime
      # Cost tracking
      score_cost:
        description: LLM cost in USD for scoring this path
        range: float

# =============================================================================
# Evidence Class (Linked semantic indicators, reusable across node types)
# =============================================================================

  Evidence:
    description: >-
      Semantic evidence extracted by LLM during scoring. Contains qualitative
      indicators that describe content type, not quantitative metrics.
      Designed for reuse across FacilityPath, CodeFile, WikiPage, etc.
    class_uri: facility:Evidence
    attributes:
      id:
        identifier: true
        description: Content-addressable hash of indicators
        required: true
      code_indicators:
        description: Programming language/framework indicators (py, f90, cmake, etc.)
        multivalued: true
      data_indicators:
        description: Data file indicators (hdf5, nc, mat, parquet, etc.)
        multivalued: true
      doc_indicators:
        description: Documentation indicators (readme, docs/, pdf, tutorial, etc.)
        multivalued: true
      imas_indicators:
        description: IMAS-specific indicators (ids, put_slice, get_slice, etc.)
        multivalued: true
      physics_indicators:
        description: Physics domain indicators (equilibrium, transport, etc.)
        multivalued: true
      quality_indicators:
        description: Code quality indicators (git, tests, ci, makefile, etc.)
        multivalued: true
      created_at:
        description: When this evidence was extracted
        range: datetime

  SoftwareRepo:
    description: >-
      A software repository representing an abstract project/codebase.
      Identity determined by remote_url (if available) or git_root_commit.
      Multiple FacilityPaths across facilities can link to same SoftwareRepo.
      Ingestion happens from remote_url (GitHub/GitLab API), not facility paths.
      
      Relationships:
      - (FacilityPath)-[:INSTANCE_OF {head_commit, branch}]->(SoftwareRepo)
      - Multiple facilities can discover same SoftwareRepo independently
      
      Schema.org alignment: Based on schema:SoftwareSourceCode vocabulary.
    mixins:
      - DiscoveryProvenance
    class_uri: facility:SoftwareRepo
    attributes:
      id:
        identifier: true
        description: >-
          Unique identifier. Format priorities:
          1. github:owner/repo (if on GitHub)
          2. gitlab:host/owner/repo (if on GitLab)
          3. internal:host/owner/repo (if on internal git server)
          4. root:{git_root_commit} (fallback for repos without remote)
        required: true
      source_type:
        description: Repository hosting type
        range: RepoSourceType
        required: true
      remote_url:
        description: >-
          Full URL to repository (e.g., https://github.com/owner/repo).
          Used for ingestion priority - repos with remote_url can be
          ingested via API without facility SSH access.
        slot_uri: schema:codeRepository
      root_commit:
        description: >-
          First commit in repository history (git root commit).
          Used to identify forks/clones across facilities when remote_url
          is unavailable. All instances with same root_commit are clones.
      is_public:
        description: Whether repository is publicly accessible (for GitHub API ingest)
        range: boolean
      name:
        description: Repository name (e.g., "imas-python")
        slot_uri: schema:name
      description:
        description: Repository description
        slot_uri: schema:description
      primary_language:
        description: Primary programming language
        slot_uri: schema:programmingLanguage
      # Git-specific metadata (captured at discovery time)
      default_branch:
        description: Default branch name (e.g., "main", "master")
      head_commit:
        description: HEAD commit hash at discovery time
      head_commit_date:
        description: Date of HEAD commit
        range: datetime
      # Discovery tracking
      discovered_at:
        description: When this repository was first discovered
        range: datetime
      discovered_via:
        description: Path where this repository was discovered
        range: FacilityPath
      # Clone tracking (populated from FacilityPath relationships)
      clone_count:
        description: Number of clones found across facility paths
        range: integer
      # Ingestion status
      should_ingest_via_github:
        description: If true, use GitHub API instead of facility SSH
        range: boolean
      ingested_at:
        description: When repository was ingested (locally or via API)
        range: datetime

# =============================================================================
# User Classes
# =============================================================================

  FacilityUser:
    description: >-
      A user account at a facility. Discovered from home directories and
      enriched with GECOS info via getent passwd. Links paths to users
      and enables cross-facility user identification.

      Relationships:
      - (FacilityUser)-[:OWNS]->(FacilityPath) - paths owned by this user
      - (FacilityUser)-[:IS_PERSON]->(Person) - cross-facility identity link
    mixins:
      - DiscoveryProvenance
    class_uri: facility:FacilityUser
    attributes:
      id:
        identifier: true
        description: Composite ID (facility:username, e.g., "iter:dubrovm")
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      username:
        description: Local username at facility
        required: true
      # Schema.org-compatible naming (maps to schema:Person properties)
      name:
        description: Full name from GECOS field (getent passwd)
        slot_uri: schema:name
      given_name:
        description: First/given name (parsed from GECOS)
        slot_uri: schema:givenName
      family_name:
        description: Last/family name (parsed from GECOS)
        slot_uri: schema:familyName
      email:
        description: Email address if discoverable
        slot_uri: schema:email
      discovered_at:
        description: When this user was discovered
        range: datetime
      enriched_at:
        description: When GECOS info was fetched
        range: datetime
      # Cross-facility linking
      person_id:
        description: Link to cross-facility Person node (if identified)
        range: Person

  Person:
    description: >-
      A researcher that may have accounts at multiple facilities.
      Uses Schema.org Person semantics for interoperability.
      Enables cross-facility user identification via ORCID or name matching.
    mixins:
      - DiscoveryProvenance
    class_uri: schema:Person
    attributes:
      id:
        identifier: true
        description: Normalized identifier (orcid:XXXX-XXXX or email)
        required: true
      name:
        description: Full name
        required: true
        slot_uri: schema:name
      given_name:
        description: First/given name
        slot_uri: schema:givenName
      family_name:
        description: Last/family name
        slot_uri: schema:familyName
      email:
        description: Primary email address
        slot_uri: schema:email
      orcid:
        description: ORCID identifier (https://orcid.org/XXXX-XXXX-XXXX-XXXX)
        slot_uri: schema:identifier
      affiliations:
        description: Known institutional affiliations
        multivalued: true
        slot_uri: schema:affiliation
      account_count:
        description: Number of facility accounts linked to this person
        range: integer
      discovered_at:
        description: When this person was first discovered
        range: datetime
      # Linked accounts populated via IS_PERSON relationship:
      # (FacilityUser)-[:IS_PERSON]->(Person)

# =============================================================================
# Data Infrastructure Classes (Public - no IPs or paths)
# =============================================================================

  MDSplusServer:
    description: An MDSplus data server (internal name only, no IP)
    class_uri: facility:MDSplusServer
    attributes:
      hostname:
        identifier: true
        description: Server name (e.g., "tcvdata", not IP address)
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      role:
        description: Server role in the infrastructure
        range: ServerRole
      description:
        description: What data this server hosts

  MDSplusTree:
    description: An MDSplus tree (hierarchical data container)
    class_uri: facility:MDSplusTree
    attributes:
      name:
        identifier: true
        description: Tree name (e.g., "tcv_shot", "results")
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      server_hostname:
        description: Primary server hosting this tree
        range: MDSplusServer
      description:
        description: Tree description
      shot_dependent:
        description: Whether tree structure varies by shot
        range: boolean
        ifabsent: "true"
      population_type:
        description: How nodes are populated (static, dynamic, hybrid)
        range: PopulationType
      # Ingestion tracking
      ingestion_status:
        description: Current ingestion status
        range: IngestionStatus
      node_count_total:
        description: Total known nodes in tree (from introspection)
        range: integer
      node_count_ingested:
        description: Number of nodes ingested to graph
        range: integer
      tdi_function_count:
        description: Number of TDI functions accessing this tree
        range: integer
      last_ingested:
        description: When tree structure was last ingested
        range: datetime
      reference_shot:
        description: Shot number used for structure introspection
        range: integer

  TreeModelVersion:
    description: >-
      A structural version of an MDSplus tree model. Captures when the
      tree structure changed and what nodes were added/removed. Enables
      the "super tree" concept where each node has applicability ranges.
    class_uri: facility:TreeModelVersion
    attributes:
      id:
        identifier: true
        description: Composite ID like tcv:results:v67
        required: true
      tree_name:
        description: Parent tree name
        required: true
        range: MDSplusTree
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      version:
        description: Sequential version number for this tree structure
        required: true
        range: integer
      first_shot:
        description: First shot where this structure was active
        required: true
        range: integer
      last_shot:
        description: Last shot with this structure (null = current model)
        range: integer
      node_count:
        description: Total nodes in this version
        range: integer
      nodes_added:
        description: Nodes added from previous version
        range: integer
      nodes_removed:
        description: Nodes removed from previous version
        range: integer
      added_subtrees:
        description: Top-level subtrees added in this version (e.g., ["BARATRON", "BOLO"])
        multivalued: true
      removed_subtrees:
        description: Top-level subtrees removed in this version
        multivalued: true
      predecessor:
        description: Previous structure version
        range: TreeModelVersion
      discovery_date:
        description: When this epoch was discovered
        range: datetime

  TreeNode:
    description: >-
      A node within an MDSplus tree. Represents a single data point that can
      be mapped to IMAS. Nodes with variants (PSI, PSI_2, PSI_3) are stored
      as a single node with a variants array, each linked to its source code.
    mixins:
      - LLMProvenance
      - LLMOperation
    class_uri: facility:TreeNode
    attributes:
      path:
        identifier: true
        description: Full node path (e.g., "\\RESULTS::LIUQE:PSI")
        required: true
      tree_name:
        description: Parent tree name
        required: true
        range: MDSplusTree
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      node_type:
        description: MDSplus node data type
        range: TreeNodeType
      source:
        description: How this node was discovered and ingested
        range: TreeNodeSource
      canonical_path:
        description: >-
          Canonical form of the path for deduplication and matching.
          Normalized to single backslash, uppercase, no channel indices.
          Used for fuzzy matching when exact path doesn't match.
      physical_path:
        description: >-
          The actual MDSplus tree path (if different from accessor name).
          For tdi_parameter nodes, this links to the physical storage.
          E.g., tdi_parameter "I_P" -> physical_path "\\RESULTS::TOP.EQ_RECON.TRACES:I_P"
      unit:
        description: Physical units for this node (linked via HAS_UNIT relationship)
        range: Unit
      description:
        description: Node description
      embedding:
        description: Vector embedding of description for semantic search
        multivalued: true
        range: float
      physics_domain:
        description: Physics domain for categorization and filtering
      example_shot:
        description: Example shot number where this node exists
        range: integer
      variants:
        description: >-
          Variant suffixes for multi-source nodes (e.g., ["", "_2", "_3"] for 
          PSI, PSI_2, PSI_3 from LIUQE, LIUQE02, LIUQE03). First element is
          the primary/canonical path. Order matches source priority.
        multivalued: true
      variant_sources:
        description: >-
          Analysis codes that produce each variant (parallel array to variants).
          E.g., ["LIUQE", "LIUQE02", "LIUQE03"] for variants ["", "_2", "_3"].
        multivalued: true
        range: AnalysisCode
      shape:
        description: Data shape description (e.g., "1D time series", "2D profile(rho, time)")
      accessor_function:
        description: TDI function that provides high-level access to this node
        range: TDIFunction
      population_type:
        description: How this node is populated (static structure vs dynamic by analysis)
        range: PopulationType
      aliases:
        description: >-
          Alternative names for this node used by accessor functions.
          E.g., FORTRAN name "I_P" for MATLAB node "I_PL" in tcv_eq.
          First entry is the canonical/preferred name for the accessor.
        multivalued: true
      parent_path:
        description: >-
          Path to parent node (computed from path at ingestion time).
          Enables hierarchy traversal without explicit relationships.
          Null for root nodes (tree level).
          Example: \\RESULTS::LIUQE:PSI -> \\RESULTS::LIUQE
        range: string
      # Applicability range ("super tree" concept)
      first_shot:
        description: >-
          First shot where this node exists in tree structure.
          Null means node exists since earliest known shot.
        range: integer
      last_shot:
        description: >-
          Last shot where this node exists. Null means node exists
          in current model (still active).
        range: integer
      introduced_version:
        description: The tree model version that introduced this node
        range: TreeModelVersion
      removed_version:
        description: The tree model version that removed this node (rare)
        range: TreeModelVersion
      # IMAS mapping preparation fields
      sign_convention:
        description: >-
          Sign convention for this quantity. Critical for IMAS mapping.
          Examples: "positive clockwise from above", "positive outward",
          "positive = current flowing counter-clockwise (COCOS 11)".
          Include COCOS reference if known.
      dimensions:
        description: >-
          Array dimension names in order, like xarray dims.
          E.g., ["time", "rho"], ["R", "Z", "time"], ["channel", "time"].
          Critical for IMAS mapping where dimension semantics matter.
        multivalued: true
      error_nodes:
        description: >-
          Associated error/uncertainty TreeNodes linked via HAS_ERROR relationship.
          E.g., for a data node like \\RESULTS::THOMSON:NE, links to error nodes
          like \\RESULTS::THOMSON:NE:ERROR_BAR or \\RESULTS::THOMSON:NE:ERROR_UPPER.
        multivalued: true
        range: TreeNode
      enrichment_source:
        description: Source of enrichment (llm_agent, manual, wiki, mdsplus)
      enrichment_confidence:
        description: >-
          Computed confidence score (0.0-1.0) based on objective signals:
          has code context, has IMAS mapping, has units, description quality.
        range: float
      enrichment_status:
        description: >-
          Lifecycle status controlling enrichment workflow.
          Nodes start as 'pending', become 'enriched' after LLM pass,
          and 'reviewed' after human validation.
        range: EnrichmentStatus
      enrichment_notes:
        description: Agent reasoning or notes about the enrichment

  TDIFunction:
    description: >-
      A TDI function providing high-level data access abstraction.
      TDI functions encapsulate tree navigation and source selection logic,
      e.g., tcv_eq("PSI", "LIUQE") handles LIUQE/FBTE equilibrium selection.
      
      Version info: TCV uses VERSION.FUN to track shot-range validity.
      Pattern: _verss array maps to _shots array, bsearch selects version.
      Return -1 means not applicable, -2 means undefined program.
    class_uri: facility:TDIFunction
    attributes:
      name:
        identifier: true
        description: Function name (e.g., "tcv_eq", "tcv_ip")
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      description:
        description: Function description and usage notes
      signature:
        description: Function signature with parameter types (e.g., "tcv_eq(signal, source, shot)")
      parameters:
        description: Function parameter names
        multivalued: true
      return_type:
        description: Return type description
      source_file:
        description: Path to the .FUN file defining this function
        range: FacilityPath
      physics_domain:
        description: Physics domain this function serves
      # Version and shot-range validity
      version:
        description: Current version number (from VERSION.FUN lookup)
        range: float
      valid_from_shot:
        description: First shot this function is valid for
        range: integer
      valid_to_shot:
        description: Last shot this function is valid for (null = current)
        range: integer
      version_history:
        description: JSON-encoded version history [{version, from_shot, to_shot}, ...]
      superseded_by:
        description: Name of replacement function if deprecated
        range: TDIFunction
      # Source selection for multi-source functions
      default_source:
        description: Default equilibrium/analysis source (e.g., "LIUQE")
      available_sources:
        description: Available source selections (e.g., ["LIUQE", "LIUQE2", "FBTE"])
        multivalued: true
      supported_quantities:
        description: >-
          Quantity names this function accepts as first argument.
          E.g., ["I_P", "R_AXIS", "PSI_AXIS", "Q_95", ...] for tcv_eq.
          Use TreeNode.aliases for name translation (FORTRAN↔MATLAB).
        multivalued: true
      quantity_definitions:
        description: >-
          JSON-encoded map of quantity name to definition.
          E.g., {"AMIN": {"expression": "tcv_eq(\"R_CONTOUR\") - R_AXIS", 
          "dependencies": ["R_CONTOUR", "R_AXIS"]}}
      quantity_categories:
        description: >-
          JSON-encoded map of category to quantity names.
          E.g., {"shape": ["AMIN", "KAPPA", "DELTA"], "energy": ["WE", "W_MHD"]}

  ShotRange:
    description: A range of shot numbers with common characteristics
    class_uri: facility:ShotRange
    attributes:
      id:
        identifier: true
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      name:
        description: Name or description of this range
      start_shot:
        description: First shot number
        range: integer
      end_shot:
        description: Last shot number (null if ongoing)
        range: integer
      description:
        description: What this shot range represents

# =============================================================================
# Data Semantics Classes
# =============================================================================

  Diagnostic:
    description: A plasma diagnostic system
    class_uri: facility:Diagnostic
    attributes:
      name:
        identifier: true
        description: Diagnostic name (e.g., "Thomson", "ECE", "MSE")
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      category:
        description: Diagnostic category
        range: DiagnosticCategory
      description:
        description: Diagnostic description

  StandardName:
    description: >-
      A canonical physics or geometric quantity name. Part of the standard_names
      vocabulary used to unify signal semantics across facilities.
      
      Relationships:
        - HAS_UNIT -> Unit (canonical units for this quantity)
        - IN_DOMAIN -> PhysicsDomainNode (optional grouping)
      
      Example: plasma_current, electron_density_core, major_radius
    class_uri: facility:StandardName
    attributes:
      id:
        identifier: true
        description: >-
          The standard name in snake_case.
          E.g., plasma_current, electron_temperature, major_radius
        required: true
      description:
        description: Human-readable definition of this quantity
      canonical_units:
        description: Expected SI units for this quantity
        range: Unit

  FacilitySignal:
    description: >-
      A facility-specific data signal. Contains ONLY signal identity and semantics.
      All access information (templates, data sources) lives in DataAccess.
      
      ID format: facility:physics_domain/signal_name[:variant]
      The physics_domain MUST be a valid PhysicsDomain enum value to ensure
      consistent categorization across facilities.
      
      Examples:
        - tcv:equilibrium/plasma_current
        - tcv:equilibrium/plasma_current:liuqe (variant from specific code)
        - tcv:magnetic_field_diagnostics/loop_voltage
        - tcv:radiation_measurement_diagnostics/radiated_power (was bolometry)
        - jet:equilibrium/plasma_current
      
      Design principle: A signal is WHAT we measure, DataAccess is HOW we fetch it.
      The same physics quantity at different facilities links to facility-specific
      DataAccess nodes but shares the same physics_domain categorization.
      
      Required relationships:
        - FACILITY_ID -> Facility
        - DATA_ACCESS -> DataAccess (code generation)
      
      Optional relationships:
        - HAS_UNIT -> Unit (data units)
        - MEASURES -> StandardName (cross-facility semantic linking)
        - MAPS_TO_IMAS -> IMASPath (IMAS data dictionary mapping)
      
      Lifecycle relationships (tree epoch tracking):
        - INTRODUCED_IN -> TreeModelVersion (epoch when signal first appeared)
        - REMOVED_IN -> TreeModelVersion (epoch when signal disappeared)
        - CHECKED_VIA -> DataAccessNode (validated data access path)
      
      Signal discovery automation strategy:
        Each data system requires bespoke discovery:
        - MDSplus: mdsvalue("$SHOTNAME"), tree traversal via getnci/treeNodeWild
        - IMAS: IDS schema is already known, enumerate from DD
        - HDF5: h5py file.visit() to enumerate paths
        - REST: OpenAPI/Swagger spec parsing
        - SQL: information_schema queries
        
        Discovery produces FacilitySignal nodes with:
        - physics_domain: classified via LLM or regex patterns
        - accessor: extracted from data system introspection
        - DATA_ACCESS edge: linked to facility's DataAccess
    class_uri: facility:FacilitySignal
    mixins:
      - DiscoveryProvenance
    attributes:
      id:
        identifier: true
        description: >-
          Format: facility:physics_domain/signal_name[:variant]
          Physics domain must match PhysicsDomain enum for consistency.
        required: true
      status:
        description: Discovery workflow status
        range: FacilitySignalStatus
        ifabsent: "discovered"
      claimed_at:
        description: >-
          Timestamp when a worker claimed this signal for processing.
          Used for distributed worker coordination. Stale claims (>5min) are reclaimed.
        range: datetime
      facility_id:
        description: Parent facility
        required: true
        range: Facility
      physics_domain:
        description: Physics domain for categorizing this signal
        range: PhysicsDomain
        required: true
      name:
        description: >-
          Human-readable signal name for display.
          E.g., "Plasma Current", "Electron Temperature Profile"
      diagnostic:
        description: >-
          Facility-specific diagnostic name if different from physics_domain.
          E.g., "bolometer_array", "thomson_scattering", "FIR_interferometer"
          This preserves facility naming while physics_domain provides consistency.
      analysis_code:
        description: >-
          Analysis code that produces this signal if applicable.
          E.g., "liuqe", "efit", "astra", "chease"
          Empty for raw diagnostic data.
      keywords:
        description: >-
          Searchable keywords for discovery. Include physics terms,
          diagnostic names, and common abbreviations.
          E.g., ["plasma current", "ip", "equilibrium"]
        multivalued: true
      aliases:
        description: >-
          Alternative names for fuzzy search. Include common abbreviations,
          parameter names, native function arguments, and legacy names.
          E.g., ["i_p", "ip", "Ip", "I_PL", "plasma current"]
        multivalued: true
      # MDSplus-specific fields (for signals discovered from tree traversal)
      tree_name:
        description: >-
          MDSplus tree name containing this signal.
          E.g., "results", "tcv_shot", "magnetics"
      node_path:
        description: >-
          Full MDSplus node path for direct access.
          E.g., "\\RESULTS::LIUQE:I_P", "\\MAGNETICS::IPL"
      tdi_function:
        description: >-
          TDI wrapper function if signal is accessed via TDI.
          E.g., "tcv_eq", "tcv_fir"
      tdi_quantity:
        description: >-
          Quantity argument passed to TDI function.
          E.g., "I_P", "NE_CORE"
      accessor:
        description: >-
          Native accessor expression - the ONLY access-specific field on signals.
          This is the expression passed to DataAccess templates.
          For MDSplus: TDI function call like "tcv_eq('i_p')"
          For IMAS: IDS path like "core_profiles.profiles_1d[0].electrons.density_thermal"
          For HDF5: dataset path like "/diagnostics/magnetics/ip"
        required: true
      data_access:
        description: >-
          DataAccess node that provides code generation templates.
          The signal's accessor is substituted into DataAccess templates.
        required: true
        range: DataAccess
      description:
        description: What this signal measures (physics description)
      embedding:
        description: Vector embedding of description for semantic search
        multivalued: true
        range: float
      units:
        description: >-
          Physical units of the signal data. Extracted from MDSplus node.units,
          data system metadata, or documentation.
          E.g., "A", "V", "T", "m^-3", "eV"
      sign_convention:
        description: >-
          Description of sign convention if relevant.
          E.g., "positive direction = co-current", "positive = outward flux"
      cocos:
        description: COCOS index if applicable to this signal
        range: integer
      is_primary:
        description: True if this is the default source for this quantity
        range: boolean
        ifabsent: "true"
      # Discovery provenance
      discovery_source:
        description: >-
          How this signal was discovered:
          - tree_traversal: MDSplus tree enumeration
          - tdi_introspection: TDI function discovery
          - imas_dd: IMAS data dictionary
          - wiki_scrape: facility documentation
          - code_analysis: extracted from source files
          - manual: human-entered
      discovered_at:
        description: When this signal was discovered
        range: datetime
      # Validation
      example_shot:
        description: Known-good shot/pulse for testing
        range: integer
      validated:
        description: Whether this signal has been tested with example_shot
        range: boolean
        ifabsent: "false"
      validation_error:
        description: Error message if validation failed

  DataAccess:
    description: >-
      Code generation template for accessing data at a facility.
      Provides the "how" to FacilitySignal's "what".
      
      An agent discovering how to access data should:
        1. Query FacilitySignal nodes for the desired quantity
        2. Follow DATA_ACCESS to get the code template
        3. Substitute placeholders in templates using signal's accessor
      
      Supports multiple access patterns:
        - MDSplus local: Tree() on same machine
        - MDSplus remote: Connection() for cross-network
        - IMAS: imas.DBEntry for IDS access
        - HDF5: h5py file access
        - REST: HTTP API calls
    class_uri: facility:DataAccess
    attributes:
      id:
        identifier: true
        description: >-
          Unique method ID: facility:system:pattern
          E.g., tcv:mdsplus:tree_tdi, iter:imas:ids_get, jet:rest:sal_api
        required: true
      facility_id:
        description: Parent facility
        required: true
        range: Facility
      name:
        description: Human-readable name (e.g., "MDSplus TDI Local", "IMAS IDS Access")
      method_type:
        description: >-
          Data system type. Used for discovery automation.
          E.g., "mdsplus", "imas", "hdf5", "rest", "sql", "csv"
        required: true
      library:
        description: >-
          Python module/package name to import.
          E.g., "MDSplus", "imas", "h5py", "requests"
        required: true
      access_type:
        description: >-
          "local" = on-machine access (e.g., Tree())
          "remote" = network access (e.g., Connection(), HTTP)
          "ssh" = access via SSH tunnel
        required: true
      # Code generation templates with placeholders
      imports_template:
        description: >-
          Python import statements.
          Example: "import MDSplus\nimport numpy as np"
      connection_template:
        description: >-
          Python code to establish connection/open data source.
          Placeholders: {server}, {data_source}, {shot}, {user}, {database}
          MDSplus: "tree = MDSplus.Tree('{data_source}', {shot}, 'readonly')"
          IMAS: "entry = imas.DBEntry(imas.imasdef.MDSPLUS_BACKEND, '{database}', {shot}, 1)"
          HDF5: "f = h5py.File('{data_source}'.format(shot={shot}), 'r')"
        required: true
      data_template:
        description: >-
          Python code to retrieve data array.
          Placeholder: {accessor}, {data_source}
          MDSplus: "data = tree.tdiExecute('data({accessor})').data()"
          IMAS: "data = entry.get('{accessor}')"
          HDF5: "data = f['{accessor}'][:]"
        required: true
      time_template:
        description: >-
          Python code to retrieve time axis. Optional for static data.
          Placeholder: {accessor}
          MDSplus: "time = tree.tdiExecute('dim_of({accessor})').data()"
          IMAS: "time = entry.get('{accessor}/../time')"
      cleanup_template:
        description: >-
          Python code to close connections/files.
          MDSplus: "tree.close()"
          HDF5: "f.close()"
      output_format:
        description: >-
          How to serialize output for remote execution.
          "json" = json.dumps(...) for small arrays
          "numpy" = binary numpy format for large arrays
          "raw" = return as-is (local only)
        ifabsent: "json"
      decimation_template:
        description: >-
          Python code for decimation. Applied before serialization.
          Placeholder: {max_points}
          Example: "step = max(1, len(data) // {max_points}); data = data[::step]; time = time[::step]"
      # Environment setup - makes DataAccess self-contained for imas-ambix
      setup_commands:
        description: >-
          Shell commands to execute before Python (module loads, env setup).
          These make the DataAccess self-contained and executable.
          E.g., ["source /etc/profile.d/modules.sh", "module load python/3.9"]
        multivalued: true
      environment_variables:
        description: >-
          Environment variables to set before execution.
          E.g., {"MDSPLUS_SERVER": "mds.facility.edu", "IMAS_VERSION": "3.42.1"}
          JSON object with string keys and values.
      verified_date:
        description: >-
          Date this access method was last validated (ISO format: YYYY-MM-DD).
          Updated when discovery_shot is successfully tested.
      documentation_url:
        description: >-
          URL to external documentation (wiki, manual, API docs).
          E.g., "https://wiki.jet.uk/display/SAL/Getting+Started"
      documentation_local:
        description: >-
          Path to documentation on the facility filesystem.
          E.g., "/common/share/docs/sal_manual.pdf"
      # Data source configuration
      data_source:
        description: >-
          Default data source name for this access method.
          Signals can override if they use a different source.
          For MDSplus: tree name (e.g., "tcv_shot", "ppf")
          For IMAS: database name
          For HDF5: file path pattern with {shot} placeholder
        required: true
      data_source_pattern:
        description: >-
          Pattern for alternative data sources at this facility.
          E.g., for TCV: ["tcv_shot", "results", "bolometer", "fir"]
        multivalued: true
      # Signal discovery configuration
      discovery_template:
        description: >-
          Python code to enumerate available signals using this access method.
          Returns list of dicts: [{"accessor": "...", "description": "...", "path": "..."}]
          
          MDSplus example:
            tree = MDSplus.Tree('{data_source}', {shot}, 'readonly')
            nodes = tree.getNodeWild('***')
            result = [{"accessor": n.path, "path": n.path} for n in nodes]
          
          IMAS example:
            from imas import imasdef
            # Enumerate from DD schema - no runtime query needed
          
          HDF5 example:
            paths = []
            f.visit(lambda p: paths.append(p) if isinstance(f[p], h5py.Dataset) else None)
            result = [{"accessor": p, "path": p} for p in paths]
      discovery_shot:
        description: Reference shot to use for signal discovery
        range: integer
      full_example:
        description: >-
          Complete working Python code example using this method.
          Should be copy-pasteable with only {shot} substitution.
          Useful for agent prompts and documentation.

  AnalysisCode:
    description: >-
      A physics analysis or simulation code that writes data to trees.
      Links to the TreeNode variants it produces (e.g., LIUQE writes PSI, PSI_2).
      Version info tracks which shots used which code version.
    class_uri: facility:AnalysisCode
    mixins:
      - COCOSMixin
    attributes:
      name:
        identifier: true
        description: Code name (e.g., "LIUQE", "ASTRA", "TORAY")
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      code_type:
        description: Type of analysis
        range: AnalysisCodeType
      description:
        description: Code description
      version:
        description: Code version if known
      installed_at:
        description: Installation path (links to FacilityPath)
        range: FacilityPath
      # Shot-range validity
      valid_from_shot:
        description: First shot this code version is valid for
        range: integer
      valid_to_shot:
        description: Last shot this code version is valid for (null = current)
        range: integer
      version_history:
        description: JSON-encoded version history [{version, from_shot, to_shot}, ...]
      # Output relationships
      writes_to_tree:
        description: Tree this code writes results to
        range: MDSplusTree
      output_variant:
        description: Variant suffix for this code's output (e.g., "_2" for LIUQE02)
      supersedes:
        description: Previous version of this code it replaces
        range: AnalysisCode

# =============================================================================
# IMAS Mapping Classes
# =============================================================================

# NOTE: IMASPath is now defined in imas_dd.yaml as the unified representation
# of IMAS Data Dictionary paths. Do not define it here.

  IMASMapping:
    description: >-
      A mapping from facility-specific data to IMAS paths.
      Contains all information needed to generate an Ambix Recipe for data pumping.
      Data flow is one-way (facility->IMAS) but searchable from either direction.
    mixins:
      - LLMProvenance
      - LLMOperation
    class_uri: facility:IMASMapping
    attributes:
      id:
        identifier: true
        required: true
      source_path:
        description: Source facility path (TreeNode path or TDI function call)
        required: true
        range: TreeNode
      target_path:
        description: Target IMAS path
        required: true
        range: IMASPath
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      
      # Pump context for Ambix Recipe generation
      driver:
        description: Data access driver (e.g., "mdsplus", "tdi", "ppf")
        range: DataSourceType
        required: true
      driver_args:
        description: Arguments for the driver (JSON-encoded, e.g., tree name, path)
      units_in:
        description: Units of the source data (must be pint-compatible)
      units_out:
        description: Units of the target IMAS path (from IMAS DD)
      scale:
        description: Numeric scale factor for transformation
        range: float
      transformation:
        description: Complex transformation expression if scale is insufficient
      
      # Validation and provenance
      validated:
        description: Whether this mapping has been validated against real data
        range: boolean
      validated_shot:
        description: Shot number used for validation
        range: integer
      confidence:
        description: Confidence level of the mapping (0.0-1.0)
        range: float
      notes:
        description: Mapping notes and caveats

# =============================================================================
# Code Examples Classes
# =============================================================================

  CodeExample:
    description: >-
      A code file containing examples of reading/writing fusion data.
      Links to facility and tracks source location for provenance.
    class_uri: facility:CodeExample
    attributes:
      id:
        identifier: true
        description: Unique identifier (facility:filename hash)
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      source_file:
        description: Remote file path (e.g., /home/wilson/data/load_to_imas.py)
        required: true
      language:
        description: Programming language
        range: ProgrammingLanguage
        required: true
      title:
        description: Human-readable title or filename
      description:
        description: Description of what this code does
      author:
        description: Username or author name if known
      related_ids:
        description: IDS names this code interacts with (coarse linking)
        multivalued: true
      ingested_at:
        description: Timestamp when this was ingested
        range: datetime

  SourceFile:
    description: >-
      A source file queued for ingestion into the knowledge graph.
      
      Lifecycle: discovered -> ingested -> stale
      On failure: any state -> failed (check error field)
      On re-scan: ingested -> stale -> discovered (if changed)
      
      SourceFile is the unit of work for the ingestion pipeline.
      Handles all file types - code, documents, data, configs.
      File category determines processing: code files get tree-sitter parsing,
      documents get text extraction, data files get schema extraction.
    class_uri: facility:SourceFile
    attributes:
      id:
        identifier: true
        description: Composite key as facility:path (e.g., tcv:/home/codes/foo.py)
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      path:
        description: Absolute remote filesystem path
        required: true
      status:
        description: Current lifecycle status
        range: SourceFileStatus
        required: true
      file_category:
        description: Category of file (code, document, data, config, notebook)
        range: FileCategory
        required: true
      language:
        description: Programming language (for code files, detected from extension)
        range: ProgrammingLanguage
      artifact_type:
        description: Artifact type (for document files)
        range: ArtifactType
      in_directory:
        description: FacilityPath that contains this file
        range: FacilityPath
      discovered_by:
        description: Scout session or pattern that found this file
      discovered_at:
        description: When this file was queued for ingestion
        range: datetime
      interest_score:
        description: Priority score from scout (0.0-1.0, higher = more interesting)
        range: float
      patterns_matched:
        description: Patterns that matched during discovery (e.g., "IMAS", "equilibrium")
        multivalued: true
      # Processing metadata
      started_at:
        description: When ingestion started (fetching state)
        range: datetime
      completed_at:
        description: When ingestion completed (ready state)
        range: datetime
      error:
        description: Error message if status is failed
      retry_count:
        description: Number of retry attempts
        range: integer
      # Output
      code_example_id:
        description: ID of created CodeExample (set when ready)
        range: CodeExample

  CodeChunk:
    description: >-
      A searchable chunk of code from a CodeExample.
      Contains embedding for semantic search. Data references are linked
      via DataReference nodes, not stored as arrays.
    class_uri: facility:CodeChunk
    attributes:
      id:
        identifier: true
        description: Unique chunk identifier
        required: true
      code_example_id:
        description: Parent CodeExample
        required: true
        range: CodeExample
      content:
        description: The actual code content
        required: true
      function_name:
        description: Function or class name if applicable
      start_line:
        description: Starting line number in source file
        range: integer
      end_line:
        description: Ending line number in source file
        range: integer
      embedding:
        description: Vector embedding for semantic search (stored as list of floats)
        multivalued: true
        range: float
      ref_count:
        description: Count of DataReference nodes linked to this chunk
        range: integer

  DataReference:
    description: >-
      A reference to external data found in source code.
      Preserves the exact string as found for provenance.
      Resolution to actual data nodes happens via typed relationships.
    class_uri: facility:DataReference
    attributes:
      id:
        identifier: true
        description: Composite key (facility:type:hash of raw_string)
        required: true
      raw_string:
        description: Exact string as found in code (e.g., "\\RESULTS::PSI")
        required: true
      normalized_path:
        description: >-
          Normalized path for fuzzy matching. Strips channel indices and
          suffixes to match tree structure nodes. E.g., CHANNEL_006 -> CHANNEL.
          Used when raw_string doesn't match any TreeNode exactly.
      ref_type:
        description: Type of data reference
        required: true
        range: DataReferenceType
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      # Typed resolution relationships
      resolves_to_tree_node:
        description: MDSplus TreeNode this reference resolves to
        range: TreeNode
        multivalued: true
      calls_tdi_function:
        description: TDI function being called (for tdi_call type)
        range: TDIFunction
      resolves_to_imas_path:
        description: IMAS path this reference resolves to (future)
        range: IMASPath
        multivalued: true

  AgentRun:
    description: >-
      Tracks a long-running agent execution for resumability and audit.
      
      Agents (discover-paths, discover-files, discover-tdi, enrich, map)
      create an AgentRun at start and update it periodically with checkpoints.
      On crash, the agent can resume from last_item_id.
      
      Budget fields enable cost/time controls for autonomous execution.
    class_uri: facility:AgentRun
    attributes:
      id:
        identifier: true
        description: UUID for this run (e.g., "tcv-discover-paths-20260107-1234")
        required: true
      facility_id:
        description: Target facility for this agent run
        required: true
        range: Facility
      agent_type:
        description: Type of agent (discover-paths, discover-files, discover-tdi, enrich, map)
        required: true
      started_at:
        description: When the agent run started
        range: datetime
        required: true
      ended_at:
        description: When the agent run completed (null if still running)
        range: datetime
      status:
        description: Current run status
        range: AgentRunStatus
        required: true
      budget_seconds:
        description: Maximum allowed run time in seconds (null = no limit)
        range: integer
      budget_cost:
        description: Maximum allowed cost in USD (null = no limit)
        range: float
      actual_cost:
        description: Actual cost incurred so far
        range: float
      items_total:
        description: Total items to process (if known at start)
        range: integer
      items_processed:
        description: Number of items processed so far
        range: integer
      items_skipped:
        description: Number of items skipped (already done, excluded)
        range: integer
      items_failed:
        description: Number of items that failed processing
        range: integer
      last_item_id:
        description: ID of last successfully processed item (for resumption)
      last_checkpoint_at:
        description: When the last checkpoint was saved
        range: datetime
      error_message:
        description: Error message if status=failed
      error_traceback:
        description: Python traceback if available
      config:
        description: JSON-encoded agent configuration (root paths, patterns, etc.)
      llm_model:
        description: LLM model used (e.g., "google/gemini-3-flash-preview")
      llm_calls:
        description: Number of LLM calls made
        range: integer
      tokens_used:
        description: Total tokens consumed
        range: integer
      # Scout-specific fields
      run_type:
        description: Type of run (scout, enrich, ingest, etc.)
      window_count:
        description: Number of windows completed (for scout sessions)
        range: integer
      accumulated_summary:
        description: Compressed context summary from previous windows

# =============================================================================
# Documentation Source Classes
# =============================================================================

  DocSource:
    description: >-
      A documentation source for discovery (wiki, readthedocs, etc.).
      Stored in graph for queryability and dynamic management.
      
      Access configuration (SSH proxy host, credentials) is stored separately:
      - credential_service references keyring service name
      - Access method details stored in facility private YAML
      
      Relationships:
      - FACILITY_ID -> Facility (optional, for facility-specific sources)
      - DOCUMENTS_CODE -> AnalysisCode (optional, for readthedocs etc.)
    class_uri: facility:DocSource
    attributes:
      id:
        identifier: true
        description: Unique identifier (e.g., "iter", "chease-readthedocs")
        required: true
      name:
        description: Human-readable name (e.g., "ITER Confluence Wiki")
        required: true
      url:
        description: Base URL of the documentation source
        required: true
      portal_page:
        description: Starting page for discovery (relative to url)
      source_type:
        description: Type of documentation site
        range: DocSourceType
        required: true
      auth_type:
        description: Authentication method required
        range: WikiAuthType
      credential_service:
        description: Keyring service name for credentials (no secrets stored)
      facility_id:
        description: Parent facility (if facility-specific)
        range: Facility
      documents_code:
        description: Code project this documents (for readthedocs, etc.)
        range: AnalysisCode
      status:
        description: Discovery status
        range: DocSourceStatus
        required: true
      last_scanned:
        description: When this source was last fully scanned
        range: datetime
      page_count:
        description: Total WikiPage nodes from this source
        range: integer
      artifact_count:
        description: Total artifact nodes from this source
        range: integer
      created_at:
        description: When this source was added
        range: datetime
      notes:
        description: Admin notes about this source

# =============================================================================
# Wiki Documentation Classes
# =============================================================================

  WikiPage:
    description: >-
      A wiki page from facility documentation (e.g., TCV wiki).
      Contains authoritative signal descriptions, conventions, and specs.
      
      Three-phase lifecycle (simple single-pass scoring):
      1. SCAN: Bulk discover via Special:AllPages → status=scanned
      2. SCORE: Fetch content + LLM scoring in one pass → status=scored
         Pages with score >= 0.5 proceed to ingestion
      3. INGEST: Embed pages with score >= 0.5 → status=ingested
      
      Worker coordination via claimed_at timestamp (same as FacilityPath).
      
      Relationships:
      - LINKS_TO -> WikiPage (wiki link structure, created during scan)
      - HAS_ARTIFACT -> WikiArtifact (created during scan)
      - FACILITY_ID -> Facility
      - MENTIONS_TREE_NODE -> TreeNode (created during ingest)
      - MENTIONS_DIAGNOSTIC -> Diagnostic
      - MENTIONS_CODE -> AnalysisCode
      - MENTIONS_DOMAIN -> PhysicsDomain
      - HAS_CHUNK -> WikiChunk (created during ingest)
    mixins:
      - LLMProvenance
      - LLMOperation
      - DiscoveryProvenance
      - ContentScoring
    class_uri: facility:WikiPage
    attributes:
      id:
        identifier: true
        description: Composite key as facility:page_name (e.g., "tcv:Thomson")
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      doc_source_id:
        description: DocSource this page came from
        range: DocSource
      url:
        description: Original wiki URL
        required: true
      title:
        description: Page title (extracted from wiki, may differ from page_name)
        required: true
      status:
        description: Lifecycle status (scanned -> scored -> discovered/skipped -> ingested)
        range: WikiPageStatus
        required: true
      
      # Graph structure fields (computed during scan)
      link_depth:
        description: Distance from portal page (0=portal, 1=direct link, etc.)
        range: integer
      in_degree:
        description: Number of pages linking TO this page (computed from LINKS_TO)
        range: integer
      out_degree:
        description: Number of pages this links TO (computed from LINKS_TO)
        range: integer
      links_to:
        description: Pages this page links to (wiki structure preserved as relationships)
        range: WikiPage
        multivalued: true
        inlined: false
        annotations:
          relationship_type: LINKS_TO
      
      # Worker coordination (same pattern as FacilityPath)
      claimed_at:
        description: >-
          Timestamp when a worker claimed this page. Used for orphan recovery.
          If set and older than timeout (5 min), page is reclaimed.
        range: datetime
      
      # Scoring (inherited from ContentScoring mixin: purpose, score,
      # Scoring inherited from ContentScoring mixin: purpose, score,
      # score dimensions, should_ingest, skip_reason, scored_at.
      # See common.yaml ContentScoring for full list.
      
      # Content preview (fetched during scoring)
      preview_text:
        description: >-
          Page content preview (first 1500 chars). Fetched during scoring.
          Used for content-aware LLM scoring and debugging.
      preview_fetched_at:
        description: When the preview was fetched for scoring
        range: datetime
      preview_fetch_error:
        description: Error message if preview fetch failed (auth, timeout, etc.)
      
      # Legacy scoring field (kept for backwards compat with existing graph data)
      is_physics_content:
        description: Whether page contains fusion/plasma physics content
        range: boolean
      
      # Discovery metadata
      discovered_at:
        description: When this page was first scanned
        range: datetime
      
      # Ingestion fields
      content_hash:
        description: SHA256 hash of content for change detection (first 16 chars)
      preview_size:
        description: Size of page content in bytes
        range: integer
      last_scraped:
        description: When this page was last fully scraped for ingestion
        range: datetime
      chunk_count:
        description: Number of WikiChunk nodes created from this page
        range: integer
      error:
        description: Error message if status is failed

  WikiChunk:
    description: >-
      A searchable chunk from a wiki page with vector embeddings.
      Uses same embedding model as CodeChunk for unified semantic search.
      
      Relationships created during ingestion:
      - HAS_CHUNK <- WikiPage (parent page, inbound from page)
      - NEXT_CHUNK -> WikiChunk (sequential navigation to next chunk)
      - DOCUMENTS -> TreeNode (MDSplus paths documented in chunk)
      - MENTIONS_IMAS -> IMASPath
      - MENTIONS_UNIT -> Unit
      - MENTIONS_CONVENTION -> SignConvention
      
      Navigation pattern (best practice from neo4j-graphrag):
      - Use NEXT_CHUNK for forward traversal in reading order
      - Query: (c)-[:NEXT_CHUNK]->(next) for next chunk
      - Query: (c)<-[:NEXT_CHUNK]-(prev) for previous chunk
      - chunk_index property for absolute positioning
    class_uri: facility:WikiChunk
    attributes:
      id:
        identifier: true
        description: Unique chunk identifier (e.g., "tcv:Thomson:chunk_0")
        required: true
      wiki_page_id:
        description: Parent WikiPage ID
        required: true
        range: WikiPage
      facility_id:
        description: Facility for efficient filtering
        required: true
        range: Facility
      chunk_index:
        description: Zero-based position in parent document (0, 1, 2, ...)
        range: integer
      section:
        description: Section heading this chunk belongs to
      content:
        description: The actual text content
        required: true
      start_char:
        description: Starting character offset in original page
        range: integer
      end_char:
        description: Ending character offset in original page
        range: integer
      embedding:
        description: Vector embedding for semantic search (256-dim, Qwen3-Embedding-8B)
        multivalued: true
        range: float
      mdsplus_paths_mentioned:
        description: MDSplus paths found in this chunk (e.g., ATLAS::IP). Only populated for MDSplus-capable facilities.
        multivalued: true
        range: string
      imas_paths_mentioned:
        description: IMAS DD paths found in this chunk (e.g., equilibrium/time_slice/profiles_1d/psi). Universal across all facilities.
        multivalued: true
        range: string
      ppf_paths_mentioned:
        description: JET PPF DDA/Dtype paths found in this chunk (e.g., EFIT/Q95). Only populated for PPF-capable facilities.
        multivalued: true
        range: string
      units_mentioned:
        description: Physical unit symbols found in this chunk (e.g., eV, Tesla, MA)
        multivalued: true
        range: string
      conventions_mentioned:
        description: Sign/coordinate convention names found in this chunk (e.g., COCOS 11)
        multivalued: true
        range: string
      tool_mentions:
        description: Facility-specific tool/API mentions found in this chunk (e.g., tdiExecute, ppfget)
        multivalued: true
        range: string

  WikiArtifact:
    description: >-
      A linked artifact (PDF, PowerPoint, image, etc.) discovered during wiki scan.
      Uses same state machine pattern as WikiPage with claimed_at for coordination.
      
      Workflow: discovered → scored → ingested
      - Bulk discovery creates artifacts with status=discovered
      - Score worker downloads preview, LLM scores based on content
      - Ingest worker downloads full content, parses, chunks, embeds
      
      Relationships:
      - FACILITY_ID -> Facility
      - HAS_ARTIFACT <- WikiPage (pages that link to this artifact)
      - HAS_CHUNK -> WikiChunk (created during ingest)
    class_uri: facility:WikiArtifact
    mixins:
      - DiscoveryProvenance
      - ContentScoring
    attributes:
      id:
        identifier: true
        description: Composite key as facility:filename (e.g., "tcv:ASTRA_manual.pdf")
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      url:
        description: Full URL to artifact
        required: true
      filename:
        description: Extracted filename (e.g., "ASTRA_manual_with_index.pdf")
        required: true
      artifact_type:
        description: Type of artifact (pdf, docx, pptx, xlsx, ipynb, etc.)
        range: ArtifactType
        required: true
      status:
        description: Lifecycle status
        range: WikiArtifactStatus
        required: true
      
      # Worker coordination (same pattern as WikiPage)
      claimed_at:
        description: >-
          Timestamp when a worker claimed this artifact for processing.
          Null when not being processed. Used for orphan recovery (>5min = reclaim).
        range: datetime
      score_exempt:
        description: >-
          When true, artifact bypasses LLM text scoring and goes directly
          from discovered → ingested. Set at discovery time for artifact types
          that use a different scoring pipeline (e.g. images use VLM captioning
          instead of text scoring). Ingestion worker claims discovered artifacts
          with this flag set.
        range: boolean
      
      # Graph metrics (computed during discovery)
      in_degree:
        description: Number of wiki pages linking TO this artifact
        range: integer
      link_depth:
        description: Minimum link depth of pages linking to this artifact
        range: integer
      
      # Scoring (inherited from ContentScoring mixin: purpose, score,
      # score_data_documentation, etc. See common.yaml for full list.)
      # Additional artifact-specific scoring fields:
      artifact_purpose:
        description: Classification of artifact content (manual, presentation, data, etc.)
        range: ContentPurpose
      preview_text:
        description: Extracted text preview from first pages (for scoring context)
      
      # Size and resource tracking
      size_bytes:
        description: File size in bytes (fetched via HTTP HEAD)
        range: integer
      page_count:
        description: Number of pages (for PDFs and presentations)
        range: integer
      chunk_count:
        description: Number of WikiChunk nodes created from this artifact
        range: integer
      
      # Timestamps
      discovered_at:
        description: When this artifact was first discovered
        range: datetime
      ingested_at:
        description: When content was extracted and embedded
        range: datetime
      
      # Error tracking
      error:
        description: Error message if status is failed
      defer_reason:
        description: Why this artifact was deferred (e.g., size limit, OCR required)

  Image:
    description: >-
      A visual resource from any source: wiki pages, documents, code output,
      or diagnostic results. Source-agnostic — attaches to any parent node
      via HAS_IMAGE relationship.
      
      Design principles:
      - Stores downsampled image bytes in graph (WebP, 768px longest side)
        so captioning works offline without facility access
      - Content-addressed ID for deduplication across pages
      - VLM caption + score in single pass (same dimensions as wiki pages)
      - Embedding generated separately by embed-update CLI, not workers
      
      Relationships:
      - FACILITY_ID -> Facility
      - HAS_IMAGE <- WikiPage (inline images in page HTML)
      - HAS_IMAGE <- WikiArtifact (standalone wiki image files)
      - HAS_IMAGE <- WikiArtifact (figures extracted from PDFs/PPTX, future)
      - HAS_IMAGE <- SourceFile (code-generated plots, future)
      - DEPICTS -> TreeNode (what the image documents, future)
      - DEPICTS -> IMASPath (IMAS concepts shown, future)
    class_uri: facility:Image
    mixins:
      - DiscoveryProvenance
      - LLMOperation
      - ContentScoring
    attributes:
      id:
        identifier: true
        description: >-
          Content-addressed: facility:sha256(source_url)[:16].
          Deduplicates images referenced from multiple pages.
        required: true
      facility_id:
        description: Parent facility
        required: true
        range: Facility
      source_url:
        description: Original URL or path where image was found
        required: true
      source_type:
        description: How this image was discovered
        range: ImageSourceType
        required: true
      filename:
        description: Original filename (e.g., "plasma_shape.png")
      mime_type:
        description: Original MIME type (image/png, image/jpeg, image/svg+xml)
      status:
        description: Processing lifecycle
        range: ImageStatus
        required: true
      
      # Stored image data (downsampled for offline captioning)
      image_data:
        description: >-
          Downsampled image bytes stored as base64-encoded string.
          Format: WebP, max 768px longest side, quality 80.
          Enables VLM captioning without facility network access.
          Typical size: 30-80KB per image.
        range: string
      image_format:
        description: Storage format of image_data (always 'webp' for new images)
      image_width:
        description: Width of stored (downsampled) image in pixels
        range: integer
      image_height:
        description: Height of stored (downsampled) image in pixels
        range: integer
      original_width:
        description: Width of original image in pixels (before downsample)
        range: integer
      original_height:
        description: Height of original image in pixels (before downsample)
        range: integer
      size_bytes:
        description: Size of original image in bytes
        range: integer
      content_hash:
        description: SHA-256 hash of original image bytes for dedup verification
      
      # VLM-generated content (populated by captioning worker)
      caption:
        description: >-
          VLM-generated description of image content. Fusion-domain-aware:
          captures physics meaning, not just visual description.
          Used as source text for embedding generation.
      alt_text:
        description: Original alt text from HTML source (if available)
      ocr_text:
        description: Text extracted via OCR from image (for diagrams with labels)
      
      # VLM scoring inherited from ContentScoring mixin: purpose, score,
      # score dimensions, description, reasoning, keywords, physics_domain,
      # should_ingest, skip_reason, score_cost, scored_at.
      # See common.yaml ContentScoring for full list.
      
      # Embedding (populated by embed-update CLI, not by workers)
      embedding:
        description: Vector embedding of caption for semantic search (256-dim)
        multivalued: true
        range: float
      
      # Context from parent resource (fed to VLM for better captions)
      page_title:
        description: Title of parent wiki page or document
      page_number:
        description: Page number in parent document (for PDF/PPTX extraction)
        range: integer
      section:
        description: Section heading where image appears in parent
      surrounding_text:
        description: >-
          Text immediately before/after image in source document.
          Truncated to ~500 chars. Provides fusion context for VLM captioning.
      
      # Worker coordination (same pattern as WikiPage)
      claimed_at:
        description: >-
          Timestamp when a worker claimed this image for processing.
          Null when not being processed. Used for orphan recovery (>5min = reclaim).
        range: datetime
      
      # Timestamps
      discovered_at:
        description: When this image reference was first found
        range: datetime
      ingested_at:
        description: When image bytes were downloaded and stored
        range: datetime
      captioned_at:
        description: When VLM captioning was completed
        range: datetime
      
      # Error tracking
      error:
        description: Error message if status=failed
